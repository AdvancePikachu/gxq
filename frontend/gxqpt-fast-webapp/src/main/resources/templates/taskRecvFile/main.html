<!doctype html>
<html lang="en">
<head>
	<meta http-equiv="Expires" content="0" />
	<meta name="renderer" content="webkit" />
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
	<!-- begin 外部CSS引入 -->
	<link type="text/css" rel="stylesheet" href="${_lib}/jqgrid/css/ui.jqgrid-bootstrap.css">
	<link type="text/css" rel="stylesheet" href="${_lib}/bootstrap/css/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="${_lib}/font-awesome/css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="${_lib}/chosen/chosen.min.css">
	<link rel="stylesheet" type="text/css"
		  href="${_lib}/jquery-step/jquery.step.css">
	<link rel="stylesheet" href="${_cp}/static/themes/blue/css/ui.css">

	<link rel="stylesheet" href="${_cp}/static/css/app.css">
	<script type="text/javascript" src="${_static}/js/lib/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="${_static}/js/lib/jquery/jquery.cookie.js" charset="utf-8"></script>
	<script type="text/javascript" src="${_js}/hengyun/hengyun_ajax.js"></script>
	<!-- end 外部CSS引入 -->
	<link href="${_css}/taskRecvFile/main.css" rel="stylesheet" type="text/css" />
</head>
<div class="workspace-body">
	<div class="console-container">
		<div class="row">
			<div class="col-sm-12">
				<!-- begin 标题 -->
				<div class="console-title console-title-border clearfix">
					<div class="pull-left">
						<h5>
							收文管理
						</h5>
					</div>
					<div class="pull-right">
						<button class="btn btn-primary btn-submits" type="button" onclick="addDcpg('addTaskRecvFile.do');">
							<span class="glyphicon glyphicon-add"></span> 新增收文
						</button>
					</div>
				</div>
			</div>
			<div class="col-sm-12">
				<!-- begin 页面内容主体 -->
				<div class="list-section">
					<div class="margin-top-1">
						<form action="javascript:" id="btn_Search_form" onclick="return false;" class="form-inline search-form">
							<div class="form-field">
								<div class="form-group">
									<label class="control-label w84">
										<span class="text-danger"></span>
										<span>处理状态：</span>
									</label>
									<div class="form-control-wrap">
										<select id="handleStatusId" name="handleStatus" class="form-control select-w w120" >
											<option value="processing" selected>办理中</option>
											<option value="finished">已办完</option>
										</select>
									</div>
								</div>
							</div>
							<div class="form-field">
								<div class="form-group">
									<label class="control-label w84">
										<span class="text-danger"></span>
										<span>文件名称：</span>
									</label>
									<div class="form-control-wrap">
										<input class="form-control w120" name="attachmentName" id="attachmentNameId" value="">
									</div>
								</div>
							</div>
							<div class="form-field">
								<div class="form-group">
									<label class="control-label w84">
										<span class="text-danger"></span>
										<span>收文编号：</span>
									</label>
									<div class="form-control-wrap">
										<input class="form-control w120" name="docNum" id="docNumId" value="">
									</div>
								</div>
							</div>
							<!--<div class="form-field">
                                <div class="form-group">
                                    <label class="control-label w84">
                                        <span class="text-danger"></span>
                                        <span>来文类型：</span>
                                    </label>
                                    <div class="form-control-wrap">
                                        <select class="form-control w120"  name="docType" id="docTypeId">
                                            <option value="">不限</option>
                                            <option value="READ_T">阅示性文件</option>
                                            <option value="13">市委主要领导批示件</option>
                                            <option value="14">市政府主要领导批示件</option>
                                            <option value="15">其他批示件</option>
                                            <option value="16">综合保障类</option>
                                            <option value="17">征求意见类</option>
                                            <option value="18">筑党办发</option>
                                            <option value="19">黔府发</option>
                                            <option value="20">筑府发</option>
                                            <option value="21">筑委专议</option>
                                            <option value="22">筑党专议</option>
                                            <option value="23">筑府办函</option>
                                            <option value="24">黔府函</option>
                                            <option value="25">黔党函</option>
                                            <option value="26">黔府办函</option>
                                            <option value="27">黔党办函</option>
                                        </select>
                                    </div>
                                </div>
                            </div>-->
							<div class="form-field">
								<div class="form-group" >
									<label class="control-label w84">
										<span class="text-danger"></span>
										<span>内容关键字：</span>
									</label>
									<div class="form-control-wrap">
										<input class="form-control w120" name="content" id="contentId" value="">
									</div>
								</div>
							</div>
							<div class="form-field">
								<div class="form-group" style="margin-right: 0;">
									<label class="control-label w84">
										<span class="text-danger"></span>
										<span>收文日期：</span>
									</label>
									<div class="form-control-wrap">
										<input class="form-control Wdate w120" id="startTimeId" onclick="WdatePicker({lang:'zh-cn',dateFmt:'yyyy-MM-dd'})" name="startTime">
									</div>
								</div>
								<div class="form-group">
									<label class="control-label">
										<span class="text-danger"></span>
										<span>至</span>
									</label>
									<div class="form-control-wrap">
										<input class="form-control Wdate w120" id="endTimeId" onclick="WdatePicker({lang:'zh-cn',dateFmt:'yyyy-MM-dd'})" name="endTime">
									</div>
								</div>
							</div>
							<div class="form-field">
								<div class="form-group">
									<div class="form-control-wrap text-right">
										<button type="button" class="btn btn-primary search-button" onclick="query();"><span class="glyphicon glyphicon-search"></span> 查询</button>
									</div>
								</div>
							</div>
						</form>
					</div>
				</div>
				<div class="list-section">
					<div class="list-content">
						<div class="form-inline view-info">
							<fieldset>
								<!-- begin 表格 -->
								<div class="grid-section">
									<table id="list">
									</table>
									<div id="pager"></div>
								</div>
								<!-- end 表格  -->
							</fieldset>
							<div class="clear"></div>
						</div>
					</div>
				</div>
				<div class="form-inline">
					<fieldset>
						<!-- <div class="col-sm-12" id="addMyStep">-->

				</div>
				</fieldset>
			</div>
			<!-- end 页面内容主体 -->
		</div>
	</div>
</div>
</div>
<!--begin 外部JS引入 -->
<script type="text/javascript" src="${_lib}/jqgrid/js/jquery.jqGrid.js"></script>
<script type="text/javascript" src="${_lib}/jqgrid/i18n/grid.locale-cn.js"></script>
<script type="text/javascript" src="${_lib}/My97DatePicker/WdatePicker.js"></script>
<script type="text/javascript" src="${_lib}/chosen/chosen.jquery.min.js"></script>
<script type="text/javascript"
		src="${_lib}/jquery-step/jquery.step.js"></script>
<script type="text/javascript" src="${_cp}/static/themes/blue/js/ui.js"></script>
<script type="text/javascript" src="${_cp}/static/js/app.js"></script>

<!--end 外部JS引入 -->
<!--begin 自定义JS -->
<script type="text/javascript">
    //alert();
    $(function() {
        Date.prototype.format = function(fmt) {
            var o = {
                "M+" : this.getMonth()+1,                 //月份
                "d+" : this.getDate(),                    //日
                "h+" : this.getHours(),                   //小时
                "m+" : this.getMinutes(),                 //分
                "s+" : this.getSeconds(),                 //秒
                "q+" : Math.floor((this.getMonth()+3)/3), //季度
                "S"  : this.getMilliseconds()             //毫秒
            };
            if(/(y+)/.test(fmt)) {
                fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length));
            }
            for(var k in o) {
                if(new RegExp("("+ k +")").test(fmt)){
                    fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));
                }
            }
            return fmt;
        }









        $("#addMyStep").html(myStep());
        addStep(0);
        //var postData = GetWebControls("#btn_Search_form");
        $("#list").jqGrid({
            mtype: 'POST',
            postData:{pageNo:1,pageSize:10, data: {"docType":"receive","handleStatus":"processing","appId": '${appId!""}'}},
            url: '${_gate_url}/api/admin/fastapplicationdoc/page',
            datatype: "json",
            contentType : 'application/json',
            serializeGridData:function(postData){
                return JSON.stringify(postData);
            },
            colNames : [ '文件名称', '收文编号', '来文机关', '创建时间', '来文类型',  '紧急程度','状态', '操作'],
            colModel : [ {name : 'attachmentName',index : 'attachmentName',width : '70'},
                {name : 'docNum',index : 'docNum',width : '60'},
                {name : 'docUnit',index : 'docUnit'},
                {name : 'createTime',index : 'createTime',width : '80',formatter :fmtTime},
                {name : 'target',index: 'target',width : '80'},
                {name : 'urgencyDegree',index : 'urgencyDegree',width : '50'},
                {name : 'linkStatus',index : 'linkStatus',hidden:true,width : '50'},
                {name : 'id',index : 'id',title : false,width : '170',align : 'center',formatter : formatterAct
                } ],
            pager : '#pager',
            height : 'auto',
            jsonReader : {
                root : 'data.list',
                page : 'data.page',
                total : 'data.total',
                records : 'data.records'
            },
            prmNames : {
                page : "data.page", // 表示请求页码的参数名称
                rows : "data.rows" // 表示请求行数的参数名称
            },
            onSelectRow: function(id){
                var rowData = $('#list').jqGrid('getRowData',id);
                $("#addMyStep").find("#myStep").remove();
                console.log(rowData.flowStatus);
                var status =0;
                if(rowData.fileTypeName=='阅示性文件'){
                    $("#addMyStep").html(myStepYd());
                    if(rowData.flowStatus=='新增或修改阅读性文件' || rowData.flowStatus== '新增收文' || rowData.flowStatus== '编辑收文'){
                        status=1;
                    }else if(rowData.flowStatus=='领导审核'){
                        status=2;
                    }else{
                        status=3;
                    }
                }else{
                    $("#addMyStep").html(myStep());
                    if(rowData.flowStatus=='编辑收文'){
                        status=1;
                    }else if(rowData.flowStatus=='处室领导审核'){
                        status=2;
                    }else if(rowData.flowStatus=='分管领导审核'){
                        status=3;
                    }else if(rowData.flowStatus=='主要领导审核'){
                        status=4;
                    }else if(rowData.flowStatus == '收文办结' || rowData.flowStatus == '已办结'){
                        status=6;
                    }else{
                        status=5;
                    }
                }
                addStep(status);
            },
        });
    });
    function myStep(){
        var myStep = "<div class='step-body' id='myStep'>";
        myStep += "<div class='step-header' style='width:100%'>";
        myStep += "<ul>";
        myStep += "<ul>";
        myStep += "<li><p>收文登记</p></li>";
        myStep += "<li><p>处室领导审批</p></li>";
        myStep += "<li><p>分管领导审批</p></li>";
        myStep += "<li><p>主要领导审批</p></li>";
        myStep += "<li><p>办理中</p></li>";
        myStep += "<li><p>办结</p></li>";
        myStep += "</ul>";
        myStep += "</div>";
        myStep += "</div>";
        return myStep;
    }
    function myStepYd(){
        var myStep = "<div class='step-body' id='myStep'>";
        myStep += "<div class='step-header' style='width:100%'>";
        myStep += "<ul>";
        myStep += "<li><p>新增或修改阅读性文件</p></li>";
        myStep += "<li><p>领导审核</p></li>";
        myStep += "<li><p>办结</p></li>";
        myStep += "</ul>";
        myStep += "</div>";
        myStep += "</div>";
        return myStep;
    }
    //流程进度条
    function addStep(i) {
        var step = $("#myStep").step({
            animate : true,
            initStep : i,
            speed : 1000
        });
    }


    function fmtTime(cellvalue, options, rawObject) {
        return new Date(rawObject.createTime).format('yyyy-MM-dd');
        if(time==null){
            return '';
        }
        //return time.substring(0,10);
    }
    function formatterAct(cellvalue, options, rawObject) {

        var handleStatus = rawObject.handleStatus;
        var linkStatus = rawObject.linkStatus;
        // var objStr = {"id":rawObject.id,title:rawObject.title,docType:rawObject.docType};
        var title = rawObject.title;
        var docType = rawObject.docType;

        var returnValue = "";
        if(handleStatus == "processing"){
            // returnValue += '<a class="ui-button" onclick="hengyunConfirm("'+cellvalue+'","'+title+'","'+docType+'","submitAudit");return false;" href="javascript:">';
            returnValue += '<a class="ui-button" onclick="submitAudit(\''+cellvalue+'\',\''+title+'\',\''+docType+'\');return false;" href="javascript:">';
            //returnValue += '<a class="ui-button" onclick="hengyunConfirm(\''+cellvalue+'\',+\''title+'\',\''+docType+'\',submitAudit);return false;" href="javascript:">';
            returnValue += '<i class="fa fa-pencil fa-fw"></i>提交</a>';
            returnValue += '<span class="oper-separator"></span>';
            returnValue += '<a class="ui-button" href="addTaskRecvFile.do?taskRecvFileId='+cellvalue+'">';
            returnValue += '<i class="fa fa-pencil fa-fw"></i>编辑</a>';
            returnValue += '<span class="oper-separator"></span>';
        }
        if(linkStatus == "mainLeader"){
            returnValue += '<a class="ui-button" onclick="submitAudit(\''+cellvalue+'\',\''+title+'\',\''+docType+'\');return false;" href="javascript:">';
            returnValue += '<i class="fa fa-pencil fa-fw"></i>办结</a>';
            returnValue += '<span class="oper-separator"></span>';
        }
        returnValue += '<a class="ui-button" href="getDetail.do?taskRecvFileId='+cellvalue+'">';
        returnValue += '<i class="fa fa-eye"></i>详情</a>';
        return returnValue;
    }

    function addDcpg(url) {
        window.location.href = url;
    }




    // function hengyunConfirm(params,method) {
    //        parent.layer.confirm("您确定提交吗？",{icon: 3, title:'确认'},function(){method(params);},function(){parent.layer.closeAll();});
    // }

    function submitAudit(id,title,docType){

        parent.layer.confirm("您确定提交吗？",{icon: 3, title:'确认'},
            function(){
                var postData = {"id":id,"title":title,"docType":docType, "appId": '${appId!""}'};

                ajaxHengyun({
                    url: '${_gate_url}/api/admin/fastapplicationdoc/approve',
                    type: "post",
                    dataType: 'json',
                    data: JSON.stringify(postData),
                    contentType: "application/json",
                    success: function(res){
                        if(res.errmsg == 'ok'){
                            query();
                            parent.layer.alert("操作成功");
                        } else {
                            parent.layer.alert(res.errMsg);
                        }
                    }
                });

            },
            function(){parent.layer.closeAll();});

    }

    //关键字搜索
    function query() {
        /*var val = $("#fileType").find('option:selected').val();
        if("READ_T"==val){
            $("#addMyStep").find("#myStep").remove();
            $("#addMyStep").html(myStepYd());
            addStep(0);
        }else{
            $("#addMyStep").find("#myStep").remove();
            $("#addMyStep").html(myStep());
            addStep(0);
        }
        var postData = GetWebControls("#btn_Search_form");*/
        var postData = {
            data: {
                //处理状态
                handleStatus: $('#handleStatusId option:selected').val(),
                // 文件名称
                fileName: $('#attachmentNameId').val(),
                // 收文编号
                docNum: $('#docNumId').val(),
                //应用ID
                appId: '${appId!""}',
                // 来文类型
                docType: "receive",
                // 关键字
                content: $('#contentId').val(),
                // 申请时间-开始
                startTime: $('#startTimeId').val(),
                // 申请时间-结束
                endTime: $('#endTimeId').val()
            },
            // pageNo: pageNo || $(".ui-pg-input").val() || 0,
            // pageSize: pageSize || $(".ui-pg-selbox").val() || 20
            pageNo: 1,
            pageSize: 10
        }

         jQuery("#list").jqGrid('setGridParam', {
            postData : postData,
            page : 1
         }).trigger('reloadGrid');
        /*jQuery("#list").jqGrid('setGridParam',
            {pageNo:1,pageSize:10, data: {"docType":"receive","handleStatus":"processing"}}
        ).trigger('reloadGrid');*/

    }


    /*
     自动获取页面控件值
     */
    function GetWebControls(element) {
        var reVal = "";
        $(element).find('input,select,textarea').each(function (r) {
            var id = $(this).prop('name');
            var value = $(this).val();
            var type = $(this).prop('type');
            if(id){
                switch (type) {
                    case "checkbox":
                        if ($(this).prop("checked")) {
                            reVal += '"' + id + '"' + ':' + '"1",';
                        } else {
                            reVal += '"' + id + '"' + ':' + '"0",';
                        }
                        break;
                    case "radio":
                        if ($(this).prop("checked")) {
                            reVal += '"' + id + '":' + '"' + $.trim(value) + '",';
                        }
                        break;
                    default:
                        if (value != "") { //如果值为空就传空，不需要传空格 -wgj
                            reVal += '"' + id + '"' + ':' + '"' + $.trim(value) + '",';
                        }else{
                            reVal += '"' + id + '"' + ':' + '"",';
                        }
                        break;
                }
            }
        });
        reVal = reVal.substr(0, reVal.length - 1);
        reVal = reVal.replace(/\\/g, '\\\\');
        reVal = reVal.replace(/\n/g, '\\n');
        return jQuery.parseJSON('{' + reVal + '}');
    }
</script>
<!--end 自定义JS -->
</body>
</html>