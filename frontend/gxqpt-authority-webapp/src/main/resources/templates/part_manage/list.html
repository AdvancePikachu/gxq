<!doctype html>
<html>

<head>
    <base href="<%=basePath%>">
    <!--<title>短信平台</title>-->
    <meta http-equiv="Expires" content="0"/>
    <meta name="renderer" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link type="text/css" rel="stylesheet" href="${_static}/js/lib/bootstrap/css/bootstrap.css">
    <link type="text/css" rel="stylesheet" href="${_static}/js/lib/jqgrid/css/ui.jqgrid-bootstrap.css">
    <link rel="stylesheet" href="${_static}/js/lib/zTree/css/zTreeStyle/zTreeStyle.css"/>
    <link rel="stylesheet" href="${_static}/themes/blue/css/ui.css">
    <link rel="stylesheet" href="${_static}/css/sys_com/com.css">
    <link rel="stylesheet" href="${_static}/css/core/module.css">
    <script src="${_static}/js/lib/jquery/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="${_static}/js/lib/zTree/js/jquery.ztree.core.min.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" src="${_static}/js/lib/zTree/js/jquery.ztree.excheck.js" charset="utf-8"></script>
    <script type="text/javascript" src="${_static}/js/lib/zTree/js/jquery.ztree.exedit.js" charset="utf-8"></script>
    <script type="text/javascript" src="${_static}/js/lib/zTree/js/jquery.ztree.exhide.js" charset="utf-8"></script>
    <script type="text/javascript" src="${_static}/js/lib/zTree/js/fuzzysearch.js" charset="utf-8"></script>
    <script type="text/javascript" src="${_static}/js/lib/jqgrid/js/jquery.jqGrid.js"></script>
    <script type="text/javascript" src="${_static}/js/lib/jqgrid/i18n/grid.locale-cn.js"></script>
    <script type="text/javascript" src="${_static}/js/app.js"></script>
    <script type="text/javascript" src="${_static}/js/module.js"></script>
    <script type="text/javascript" src="${_static}/js/lib/serializeJSON/jquery.serializejson.min.js"></script>
    <script type="text/javascript" src="${_static}/js/lib/jquery/jquery.cookie.js" charset="utf-8"></script>
    <script type="text/javascript" src="${_static}/js/hengyun/hengyun_ajax.js"></script>
    <script type="text/javascript" src="${_static}/js/hengyun/hengyun_resource.js"></script>
    <style>
        .searchDiv{
            font-size: 14px;
            margin: 10px 10px 0;
        }
        .searchDiv input{
            padding: 2px 5px;
            outline: none;
            width: 136px;
        }
    </style>
</head>

<body>
<div class="workspace-body">
    <div class="console-container clearfix">
        <div class="col-sm-12">
            <!-- begin 标题 -->
            <div class="console-title console-title-border clearfix">
                <div class="pull-left">
                    <h5 class="page-title">
                        权限管理系统 &gt; 用户中心 &gt; <span class="page-title-scend">部门管理</span>
                    </h5>
                </div>
                <div class="pull-right">
                </div>
            </div>
        </div>
        <!-- begin 页面内容主体 -->
        <div class="main clearfix">
            <div class="top-bar">
                <lable class="change-system_tle">体系：</lable><select id="system" class="form-control change-system" onchange="changeSystem(this)"></select>
            </div>
            <div class="content clearfix">
                <div class="organ-list-tree pull-left">
                    <div class="panel panel-primary">
                        <div class="panel-heading">组织机构</div>
                        <div class="panel-body">
                            <div class="zTreeDemoBackground left">
                                <div class="searchDiv">
                                    <label class="control-label">
                                        <span class="text-danger"></span>
                                        <span>名称：</span>
                                    </label>
                                    <input id="orgName" class="" placeholder=""/>
                                </div>
                                <ul id="ztree" class="ztree"></ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="right-box" class="right-box pull-left">
                    <div class="">
                        <div class="list-section">
                            <form autocomplete="off" id="myForm" action="" class="form-inline search-form">
                                <div class="form-field">
                                    <div class="form-group">
                                        <label class="control-label">
                                            <span class="text-danger"></span>
                                            <span>部门全称：</span>
                                        </label>
                                        <div class="form-control-wrap">
                                            <input name="name" class="form-control" placeholder=""/>
                                        </div>
                                    </div>
                                </div>
                                <!--<div class="form-field">-->
                                <!--<div class="form-group">-->
                                <!--<label class="control-label">-->
                                <!--<span class="text-danger"></span>-->
                                <!--<span>所属类型：</span>-->
                                <!--</label>-->
                                <!--<select name="forType" class="form-control chosen-select selWid-form-search">-->
                                <!--<option value="">全部</option>-->
                                <!--</select>-->
                                <!--</div>-->
                                <!--</div>-->
                                <!--<div class="form-field">-->
                                <!--<div class="form-group">-->
                                <!--<label class="control-label">-->
                                <!--<span class="text-danger"></span>-->
                                <!--<span>所属级别：</span>-->
                                <!--</label>-->
                                <!--<select name="forClass" class="form-control chosen-select selWid-form-search">-->
                                <!--<option value="">全部</option>-->
                                <!--</select>-->
                                <!--</div>-->
                                <!--</div>-->
                                <!--<div class="form-field">-->
                                <!--<div class="form-group">-->
                                <!--<label class="control-label">-->
                                <!--<span class="text-danger"></span>-->
                                <!--<span>所属系统</span>-->
                                <!--</label>-->
                                <!--<select name="forindustry" class="form-control chosen-select selWid-form-search">-->
                                <!--<option value="">全部</option>-->
                                <!--</select>-->
                                <!--</div>-->
                                <!--</div>-->
                                <div class="form-field">
                                    <div class="form-group">
                                        <label class="control-label">
                                            <span class="text-danger"></span>
                                            <span>启用标记：</span>
                                        </label>
                                        <div class="form-control-wrap">
                                            <select name="isenable"
                                                    class="form-control chosen-select selWid-form-search">
                                                <option value="">所有</option>
                                                <option value="1">启用</option>
                                                <option value="0">禁用</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-field">
                                    <div class="form-group">
                                        <div class="form-control-wrap text-right">
                                            <button type="button" class="btn btn-primary search-button"
                                                    onclick="reloadPart()">
                                                <span class="glyphicon glyphicon-search"></span> 查询
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="">
                                    <div class="btn-group" role="group" aria-label="...">
                                       <!-- <button type="button" class="btn btn-default btn-add" onclick="createPage()">新增</button>-->
                                        <!--<button type="button" class="btn btn-default" onclick="createPage()">新增</button>
                                        <button type="button" class="btn btn-default btnIn">导入</button>
                                        <button type="button"  class="btn btn-default" onclick="exportDpm()">导出</button>
                                        <button type="button" class="btn btn-default templet">模板下载</button>
                                        &lt;!&ndash;<button type="button" class="btn btn-default">打印</button>&ndash;&gt;
                                        <button type="button" class="btn btn-default" onclick="unableToggle(0)">禁用</button>
                                        <button type="button" class="btn btn-default" onclick="unableToggle(1)">启用</button>-->
                                        <!-- /*按钮权限开始*/-->
                                        <script type="text/javascript" id="authority_part_add">
                                            resourceJs.init("${_gate_url!''}","${_app_id!''}","${l_u_i_s.id!''}").containButton({
                                                resource_code : "authority_part_add",
                                                //btnHtml :"<button type=\"button\" class=\"btn btn-default btn-add \" onclick=\"createPage()\">新增</button>",
                                                btnHtml :'<button type="button" class="btn btn-default btn-add" onclick="createPage()">{{name}}</button>',
                                                htmlInsert: true
                                            });
                                        </script>
                                        <script type="text/javascript" id="authority_part_import">
                                            resourceJs.init("${_gate_url!''}","${_app_id!''}","${l_u_i_s.id!''}").containButton({
                                                resource_code : "authority_part_import",
                                                //btnHtml :"<button type=\"button\" class=\"btn btn-default btnIn\" >导入</button>",
                                                btnHtml :'<button type="button" class="btn btn-default btnIn">{{name}}</button>',
                                                htmlInsert: true
                                            });
                                        </script>
                                        <script type="text/javascript" id="authority_part_export">
                                            resourceJs.init("${_gate_url!''}","${_app_id!''}","${l_u_i_s.id!''}").containButton({
                                                resource_code : "authority_part_export",
                                                //btnHtml :"<button type=\"button\" class=\"btn btn-default \" onclick=\"exportDpm()\">导出</button>",
                                                btnHtml :'<button type="button" class="btn btn-default btn-add" onclick="exportDpm()">{{name}}</button>',
                                                htmlInsert: true
                                            });
                                        </script>
                                        <script type="text/javascript" id="authority_part_downloadTemplet">
                                            resourceJs.init("${_gate_url!''}","${_app_id!''}","${l_u_i_s.id!''}").containButton({
                                                resource_code : "authority_part_downloadTemplet",
                                                //btnHtml :"<button type=\"button\" class=\"btn btn-default templet \" >模板下载</button>",
                                                btnHtml :'<button type="button" class="btn btn-default templet">{{name}}</button>',
                                                htmlInsert: true
                                            });
                                        </script>
                                        <script type="text/javascript" id="authority_part_disenable">
                                            resourceJs.init("${_gate_url!''}","${_app_id!''}","${l_u_i_s.id!''}").containButton({
                                                resource_code : "authority_part_disenable",
                                                //btnHtml :"<button type=\"button\" class=\"btn btn-default \" onclick=\"unableToggle(0)\">启用</button>",
                                                btnHtml :'<button type="button" class="btn btn-default " onclick="unableToggle(0)">{{name}}</button>',
                                                htmlInsert: true
                                            });
                                        </script>
                                        <script type="text/javascript" id="authority_part_ennable">
                                            resourceJs.init("${_gate_url!''}","${_app_id!''}","${l_u_i_s.id!''}").containButton({
                                                resource_code : "authority_part_ennable",
                                                //btnHtml :"<button type=\"button\" class=\"btn btn-default \" onclick=\"unableToggle(1)\">禁用</button>",
                                                btnHtml :'<button type="button" class="btn btn-default " onclick="unableToggle(1)">{{name}}</button>',
                                                htmlInsert: true
                                            });
                                        </script>
                                        <!-- /*按钮权限end*/-->
                                    </div>
                                </div>
                            </form>
                        </div>
                        <!--导入start-->
                        <div class="list-section">
                            <div class="list-content">
                                <div class="form-inline">
                                    <fieldset>
                                        <div class="grid-section">
                                            <table id="list">
                                            </table>
                                            <div id="pager"></div>
                                        </div>
                                        <table class="table dealInfoTab" style="display:none;">
                                            <tbody>
                                            <tr>
                                                <td>
                                                    <div class="w90 form-control-wrap" style="width:100%;">
                                                        <div id="container" style="margin: 0;padding: 0; width:98%;">
                                                            <div id="uploader1" class="uploader">
                                                                <div class="queueList">
                                                                    <ul id="file_html" class="filelist">
                                                                    </ul>
                                                                    <div id="dndArea1" class="placeholder dndArea"
                                                                         style="padding-top: 85px;">
                                                                        <div id="filePicker1" class="filePicker"></div>
                                                                        <p></p>
                                                                    </div>
                                                                </div>
                                                                <div class="statusBar" style="display:none;">
                                                                    <div class="progress">
                                                                        <span class="text">0%</span> <span
                                                                            class="percentage"></span>
                                                                    </div>
                                                                    <div class="info"></div>

                                                                    <div class="btns">
                                                                        <div id="jxButton1" class="jxButton"></div>
                                                                        <div class="uploadBtn">开始上传</div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </fieldset>
                                </div>
                            </div>
                        </div>
                        <!--导入end-->
                        <div class="list-section">
                            <div class="list-content">
                                <div class="form-inline">
                                    <fieldset>
                                        <div class="grid-section">
                                            <table id="list1">
                                            </table>
                                            <div id="pager1"></div>
                                        </div>
                                    </fieldset>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- end 页面内容主体 -->
    </div>
</div>
<script type="text/javascript">
    var _GATE_URL = "${_gate_url}";
    // var _GATE_URL = "http://192.168.1.124:9770";
</script>
<script type="text/javascript" src="${_static}/js/lib/webuploader/webuploader.js"></script>
<script type="text/javascript" src="${_static}/js/lib/webuploader/HYCore2.js"></script>
<script type="text/javascript">
    var systemCode = null;
    var orgId = null;
    var tableObj = null;//jqgrid表对象
    var treeObj = null;//部门树对象
    var organListArray = [];
    var fileUpload1 = null;//上传文件对象
    var node = null;//当前节点
    var height = $("#right-box").height() - 160;

    function initData() {
        systemCode = null;
        orgId = null;
        treeObj && treeObj.destroy();//将树置空
        // treeObj = null;//部门树对象
        tableObj && tableObj.jqGrid("clearGridData");
        organListArray = [];
        fileUpload1 = null;//上传文件对象
        node = null;
    }

    //获取体系
    getSystem();

    function getSystem() {
        ajaxHengyun({
            type: 'POST',
            url: '${_gate_url}/api/admin/system/findSystemList',
            data:JSON.stringify({pageNo: 1, pageSize: 20,data:{}}),
            contentType : 'application/json',
            datatype: "json",
            success: function (data) {
                if (data.data.list.length) {
                    systemCode = data.data.list[0].code;
                    // if (systemCode == 'sdzzww') {
                    //     $('.btn-group .btn').attr('disabled', true);
                    // } else {
                    //     $('.btn-group .btn').attr('disabled', false);
                    // }
                    $.each(data.data.list, function (index, item) {
                        var option = ''
                        if(item.code === 'gxqpt'){
                            option = '<option value = ' + item.code + ' selected>' + item.name + '</option>';
                            systemCode = item.code;
                            systemName = item.name;
                            $('.btn-group button').attr('disabled',false);
                        }else{
                            option = '<option value = ' + item.code + '>' + item.name + '</option>';
                        }
                        $('#system').append(option);
                    })
                    getOrgan();
                }
            }
        });
    }

    /*体系切换*/
    function changeSystem(obj) {
        // if ($(obj).find('option:selected').val() == 'sdzzww') {
        //     $('.btn-group .btn').attr('disabled', true);
        // } else {
        //     $('.btn-group .btn').attr('disabled', false);
        // }
        initData();
        systemCode = $(obj).val();
        getOrgan();
    }

    //获取单位部门
    function getOrgan() {
        ajaxHengyun({
            type: 'GET',
            url: '${_gate_url}/api/admin/gxqpt/org/find',
            // url: 'http://192.168.1.124:9770/api/admin/gxqpt/org/find',
            data: {systemCode: systemCode,type:1},
            success: function (data) {
                if (data.data && data.data.length) {
                    var units = data.data;
                    if(!node){
                        units[0].open = true;
                    }
                    var nodes = builderTree(units);
                    var setting = {
                        data: {
                            key: {
                                name: 'name'
                            },
                            simpleData: {
                                idKey: 'id',
                            }
                        },
                        callback: {
                            onClick: onClick,
                        }
                    };
                    $.fn.zTree.init($("#ztree"), setting, nodes);
                    /* 生成树 */
                    treeObj = $.fn.zTree.getZTreeObj("ztree");
                    /*
                    *初始化模糊搜索方法
                    * fuzzySearch(zTreeId, searchField, isHighLight, isExpand)
                    *@param zTreeId ztree对象的id,不需要#
					* @param searchField 输入框选择器
					* @param isHighLight 是否高亮,默认高亮,传入false禁用
					* @param isExpand 是否展开,默认合拢,传入true展开
                    */
                    fuzzySearch('ztree','#orgName',false,false);
                    if(node){
                        treeObj.selectNode(node);
                    }else {
                        var nodes = treeObj.getNodes();
                        node = nodes[0];
                        treeObj.selectNode(nodes[0]);
                    }
                    getPart();
                    loadFile();
                    reloadPart();
                }
                if (systemCode == 'sdzzww' || !data.data || !data.data.length) {
                    $('.btn-group .btn').attr('disabled', true);
                } else {
                    $('.btn-group .btn').attr('disabled', false);
                }
            }
        })
    }

    /*创建树*/
    function builderTree(r) {

        if (!r || r.length == 0) {
            return;
        }
        r.forEach(function (value, index) {

            var isChildOrg = true;
            if (!value.children || value.children.length == 0) {
                value.children = [];
                isChildOrg = false;
            }
            if (!(!value.dpms || value.dpms.length == 0)) {
                value.dpms.forEach(function (item, index) {
                    item.icon = '${_static}/images/sys_com/icn_02.png';
                    value.children.push(item);
                });
            }
            if (isChildOrg) {
                builderTree(value.children);
            }
            if(node && node.id == value.id){
                value.open = true;
            }
            if(value.treeType == '1'){
                value.icon = '${_static}/images/sys_com/icn_01.png';
            }else{
                value.icon = '${_static}/images/sys_com/icn_02.png';
            }
            return;
        });
        return r;
    }

    //插入部门
    function insertNode(obj) {
        obj.icon = '${_static}/images/sys_com/icn_02.png';
        treeObj.addNodes(node, -1, obj);
    }

    //修改部门
    function editNode(obj) {
        var node = treeObj.getNodesByParam('id', obj.id, null);
        node[0].name = obj.name;
        treeObj.updateNode(node[0]);
    }

    //删除子单位
    function deleteNode(id) {
        var node = treeObj.getNodesByParam('id', id, null);
        treeObj.removeNode(node[0]);
    }

    //获取部门
    function getPart() {
        var data = {systemCode: systemCode, orgId: null, parentId: null}
        if (node.treeType == '1') {
            data.orgId = node.id;
        }
        tableObj = $("#list").jqGrid({
            mtype: 'POST',
            url: "${_gate_url}/api/admin/gxqpt/dpm/pageLike",
            // url: "http://192.168.1.124:9770/api/admin/gxqpt/dpm/pageLike",
            postData: {pageNo: 1, pageSize: 20, data: data},
            dataType: 'json',
            contentType: 'application/json',
            serializeGridData: function (postData) {
                return JSON.stringify(postData);
            },
            colNames: ['部门全称', '状态', '启用标记', '操作'],
            colModel: [{
                name: 'name',
                index: 'name'
            }, {
                name: 'status',
                index: 'status',
                formatter:formatterStatus,
            }, {
                name: 'isenable',
                index: 'isenable',
                formatter: formatterEnable
            }, {
                name: 'act',
                index: 'act',
                title: false,
                width: '425',
                align: 'center',
                formatter: formatterAct
            }],
            jsonReader: {
                root: "data.list",
                page: "data.pageNum",
                total: "data.pages",
                records: "data.total"
            },
            multiselect: true,
            pager: '#pager',
            height: height,
            loadComplete: function () {
                var rowIds = jQuery("#list").jqGrid('getDataIDs');
                if (organListArray.length > 0) {
                    for (var k = 0; k < rowIds.length; k++) {
                        var curRowData = jQuery("#list").jqGrid('getRowData', rowIds[k]);
                        var curChk = $("#list tr[id=" + rowIds[k] + "]").find(":checkbox");
                        $.each(organListArray, function (i, data) {
                            if (rowIds[k] == data) {
                                curChk.attr('checked', 'true');
                                $("#list").jqGrid('setSelection', data);
                            }
                        });
                    }
                }

            },
            beforeSelectRow: function (rowid, e) {//多选
                if (e.type == 'click') {
                    i = $.jgrid.getCellIndex($(e.target).closest('td')[0]),
                        cm = jQuery("#list").jqGrid('getGridParam', 'colModel');
                    return (cm[i].name == 'cb'); //当点击的单元格的名字为cb时，才触发选择行事件
                }
                return false;
            },
            onSelectAll: function (aRowids, status) {
                if (status) {
                    for (var i = 0; i < aRowids.length; i++) {
                        var curRowData = jQuery("#list").jqGrid('getRowData', aRowids[i]);
                        organListArray.push(aRowids[i]);
                        organListArray = removeDuplicatedItem(organListArray);
                    }
                } else {
                    for (var i = 0; i < aRowids.length; i++) {
                        var ret = jQuery.inArray(aRowids, organListArray);
                        organListArray.splice(ret, 1);
                    }
                }
            },
            onSelectRow: function (id, check) {
                if (check) {
                    var curRowData = jQuery("#list").jqGrid('getRowData', id);
                    organListArray.push(id);
                    organListArray = removeDuplicatedItem(organListArray);
                } else {
                    var ret = jQuery.inArray(id, organListArray);
                    organListArray.splice(ret, 1);
                }
            },
            onPaging: function (pgButton) {
                var data = {};
                var pageNo = $(".ui-pg-input").val();
                pageNo = parseInt(pageNo);
                var total = ($("#sp_1_pager_toppager").text()).replace(/,/g,'');
                total = parseInt(total);
                if (pgButton == "next") {
                    if (pageNo >= total) {
                        return false;
                    } else {
                        pageNo += 1;
                    }
                } else if (pgButton == "prev") {
                    if (pageNo > 1) {
                        pageNo -= 1;
                    } else {
                        return false;
                    }
                } else if (pgButton == "last") {
                    pageNo = total;
                } else if (pgButton == "first") {
                    pageNo = 1;
                }
                var pageSize = $(".ui-pg-selbox").val();
                if (pageNo != 0) {
                    if(node.treeType == 1){
                        data.orgId = node.orgId;
                    }else{
                        data.orgId = node.orgId;
                        data.parentId = node.id;
                        data.systemCode = systemCode;
                    }
                    $("#list").setGridParam({
                        postData: {
                            pageNo: pageNo,
                            pageSize: pageSize,
                            data: data
                        }
                    }).trigger("reloadGrid");
                    return false;
                }
            }
        });
    };

    function formatterAct(cellvalue, options, rawObject) {
        var returnValue = "";
        /*returnValue += '<a class="ui-button marginLeft" href="javascript:" onclick="viewPage(' + rawObject.id + ')">';
        returnValue += '详请</a>';*/
        returnValue += resourceJs.init("${_gate_url!''}","${_app_id!''}","${l_u_i_s.id!''}").containButton({
            resource_code : "authority_part_detail",
            btnHtml :"<a class=\"ui-button marginLeft\" href=\"javascript:\" onclick=\"viewPage('"+rawObject.id+"')\">详请</a>",
            htmlInsert: false
        });

        if(systemCode != 'sdzzww') {
           /* returnValue += '<span class="oper-separator"></span>';
            returnValue += '<a class="ui-button" href="javascript:" onclick="editPage(' + rawObject.id + ')">';
            returnValue += '修改</a>';
            returnValue += '<span class="oper-separator"></span>';
            returnValue += '<a class="ui-button marginLeft" href="javascript:void(0);" onclick="delect(' + rawObject.id + ')">';
            returnValue += '删除</a>';*/
            returnValue += resourceJs.init("${_gate_url!''}","${_app_id!''}","${l_u_i_s.id!''}").containButton({
                resource_code : "authority_part_update",
                btnHtml :"<span class=\"oper-separator\"></span><a class=\"ui-button\" href=\"javascript:\" onclick=\"editPage('"+rawObject.id+"')\">修改</a>",
                htmlInsert: false
            });
            returnValue += resourceJs.init("${_gate_url!''}","${_app_id!''}","${l_u_i_s.id!''}").containButton({
                resource_code : "authority_part_delete",
                btnHtml :"<span class=\"oper-separator\"></span><a class=\"ui-button marginLeft \" href=\"javascript:\" onclick=\"delect('"+rawObject.id+"')\">删除</a>",
                htmlInsert: false
            });
        }
        return returnValue;
    }
    
    function formatterStatus(cellvalue,options,rawObject) {
        var returnValue = "";
        if(cellvalue == '1'){
            returnValue += '<span>正常</span>'
        }else if(cellvalue == '2'){
            returnValue += '<span>待撤销</span>'
        }else if(cellvalue == '3'){
            returnValue += '<span>已撤销</span>'
        }
        return returnValue;
    }

    function formatterEnable(cellvalue, options, rawObject) {
        var returnValue = "";
        if (cellvalue == '1') {
            returnValue += '<span>启用</span>'
        } else {
            returnValue += '<span class="text-danger">禁用</span>'
        }
        return returnValue;
    }

    /*点击资源节点查看资源详情*/
    function onClick(event, treeId, treeNode) {
        node = treeNode;
        reloadPart();
        loadFile();
    };

    //刷新部门
    function reloadPart() {
        var data = $('#myForm').serializeJSON();
        if (node.treeType == '1') {
            data.orgId = node.id;
        } else if (node.treeType == '2') {
            data.parentId = node.id;
        }
        data.systemCode = systemCode;
        tableObj.setGridParam({
            postData: {pageNo: 1, pageSize: Number($('.ui-pg-selbox').val()), data: data}
        }, true).trigger("reloadGrid");
    }

    /* 删除 */
    function delect(id) {
        parent.layer.confirm("您确定要删除吗？", {
            title: '温馨提示',
            shade: [0.4, '#000'],
            btn: ['确定', '取消'] //按钮
        }, function () {
            ajaxHengyun({
                type: 'POST',
                url: '${_gate_url}/api/admin/gxqpt/dpm/remove',
                // url:'http://192.168.1.124:9770/api/admin/gxqpt/dpm/remove',
                data: {ids: [id]},
                success: function (res) {
                    if (res.data) {
                        deleteNode(id);
                        reloadPart();
                    } else {
                        if(res.errmsg == "fail") {
                            parent.layer.msg("删除单位出错，请重试！", {time: 1000});
                        }else{
                            parent.layer.msg(res.errmsg, {time: 2000})
                        }
                    }
                }
            })
            closeLayer();
        }, function () {
            closeLayer();
        });
    }


    /* 弹出新增页面 */
    function createPage() {
        if(node.treeType == '1'){
            parent.layer.open({
                id: 'create',
                type: 2,
                anim: 6,
                title: '新增部门',
                maxmin: false, //开启最大化最小化按钮
                area: ['80%', '55%'],
                content: "${_cp}/power/partCreate",
                btn: ['<span class="glyphicon glyphicon-ok"></span> 新增', '<span class="glyphicon glyphicon-remove"></span> 取消'],
                yes: function (index, layero) {
                    var html = layero.context;
                    var Id = html.getElementById("create");
                    var iframe = $(Id).find("iframe").attr("name");
                    var rowData = parent[iframe].save(index);
                }
            });
        }else{
            parent.layer.msg("不允许在部门下面新增部门", {time: 1000});
        }
    }

    /* 弹出详情页面 */
    function viewPage(id) {
        parent.layer.open({
            id: 'view',
            type: 2,
            anim: 6,
            title: '部门详情',
            maxmin: false, //开启最大化最小化按钮
            area: ['80%', '55%'],
            content: "${_cp}/power/partView?id=" + id,
            btn: ['<span class="glyphicon glyphicon-remove"></span> 关闭'],
        });
    }

    /* 弹出修改页面 */
    function editPage(id) {
        parent.layer.open({
            id: 'create',
            type: 2,
            anim: 6,
            title: '修改部门',
            maxmin: false, //开启最大化最小化按钮
            area: ['80%', '55%'],
            content: "${_cp}/power/partEdit?id=" + id,
            btn: ['<span class="glyphicon glyphicon-ok"></span> 更新', '<span class="glyphicon glyphicon-remove"></span> 取消'],
            yes: function (index, layero) {
                var html = layero.context;
                var Id = html.getElementById("create");
                var iframe = $(Id).find("iframe").attr("name");
                var rowData = parent[iframe].save(index);
            }
        });
    }

    /*导入*/
    $(".btnIn").click(function () {
        if (node.treeType == '2') {
            parent.layer.msg("请选择单位导入部门！", {time: 1000});
            return false;
        }
        $("#filePicker1 div > label").click();
    });
    /*导出*/
    function exportDpm() {
        if(organListArray.length){
            var urlStr = '${_gate_url}/api/admin/gxqpt/dpm/export?token='+getCurToken()+'&';
            $.each(organListArray,function (index,value) {
                urlStr += 'ids[]='+value+'&';
            })
            window.location.href = urlStr;
        }else{
            parent.layer.msg('请选择要导出的单位',{icon: 7});
        }
    }
    /* 模板下载 */
    $(".templet").click(function () {
        var urlStr = '${_gate_url}/api/admin/gxqpt/dpm/downloadTemplet';
        // var urlStr = '${_static}/templet/部门信息导入模板.xls';
        window.location.href = urlStr;
    });
    //$(".btnOutFail").hide();
    /* 附件上传 begin */
    function loadFile() {
        if (node.treeType == '1') {
            orgId = node.id;
        }
        fileUpload1 = new FileUpload({
            "filePicker": "filePicker1",
            "fileType":"xls",
            "dndArea": "dndArea1",
            "uploader": "uploader1",
            "jxButton": "jxButton1",
            "busType": "b_lxmb_pjzb",
            "tipMsg": "只能上传.xls后缀的目标文件",
            "orgid": orgId,
        });
    }
    //启用或禁用
    function unableToggle(type) {
        if (organListArray.length == 0){
            parent.layer.msg("请选择部门！", {icon: 5, time: 1000});
            return ;
        }
        ajaxHengyun({
            type:'POST',
            url:'${_gate_url}/api/admin/gxqpt/dpm/updateEnable',
            // url:'http://192.168.1.124:9770/api/admin/gxqpt/org/updateEnable',
            data:{ids:organListArray,isenble:type},
            success:function (res) {
                if(res.data){
                    reloadPart();
                    parent.layer.msg("操作成功！", {icon: 6, time: 1000});
                }else{
                    parent.layer.msg("操作失败！", {icon: 5, time: 1000});
                }
            }
        })
    }
    // var FileList = new Array();

    function successUpload(json) {
        reloadPart();
        getOrgan();
        if (json.errmsg == "ok") {
            parent.layer.msg("导入成功" + json.data.length + "条！", {icon: 6, time: 1000});
        } else {
            parent.layer.msg(json.errmsg, {icon: 6, time: 3000});
        }
        fileUpload1 = new FileUpload({
            "filePicker": "filePicker1",
            "fileType":"xls",
            "dndArea": "dndArea1",
            "uploader": "uploader1",
            "jxButton": "jxButton1",
            "busType": "b_lxmb_pjzb",
            "tipMsg": "只能上传.xls后缀的目标文件",
            "orgid": orgId,
        });
    }
</script>
</body>

</html>