<template>
	<div class="wAuto">
		<Layout>
			<Content>
				<Breadcrumb>
					<BreadcrumbItem>统一监控平台</BreadcrumbItem>
					<BreadcrumbItem>预警处理台账</BreadcrumbItem>
				</Breadcrumb>
                <Layout class="ivu-layout-has-sider">
                    <Col span="3">
                        <Menu
                            active-name="1-1"
                            :open-names="[1]"
                            style="height:100%;border-bottom:1px solid #ccc">
                            <template v-for="(item, i) in perList">
                                <template v-if="item.dpms.length > 0">
                                    <Submenu :name="i">
                                        <template slot="title">
                                            <Icon type="ios-analytics"></Icon>
                                            {{item.name}}
                                        </template>
                                        <template v-for="(menu, j) in item.dpms">
                                            <MenuItem
                                                :name="`${i-j}`"
                                                @on-select="changeItem(menu.systemCode, item.id, menu.id)">
                                                {{menu.name}}
                                            </MenuItem>
                                        </template>
                                    </Submenu>
                                </template>
                                <template v-else>
                                    <MenuItem :name="item.name">
                                        <Icon type="heart"></Icon>
                                        {{item.name}}
                                    </MenuItem>
                                </template>
                            </template>
                        </Menu>
                    </Col>
                    <Col span="20" style="margin-left:10px;">
                        <Menu active-name="1" style="width:100%;height:100%;">
                            <MenuGroup title="人员列表">
                                <Card>
                                    <Form ref="formValidate" inline :label-width="90">
                                        <FormItem label="关键字">
                                            <Input type="text" placeholder="请输入姓名、性别、职位"></Input>
                                        </FormItem>
                                        <FormItem>
                                            <Button type="info">查询</Button>
                                        </FormItem>
                                    </Form>
                                    <Table border ref="selection" :columns="columns" :data="data"></Table>
                                    <div class="bottom-bar">
                                        <Page :total="100" show-sizer show-elevator></Page>
                                    </div>
                                </Card>
                            </MenuGroup>
                        </Menu>
                    </Col>
                </Layout>
			</Content>
			<Modal @on-visible-change="openModal" v-model="modal" title="详情" class-name="vertical-center-modal" width="60%">
				<div style="text-align:center">
                    <Form ref="evalData" :model="evalData" :rules="ruleValidate" :label-width="70">
                        <Row :gutter="40">
                            <Col span="12">
                                <FormItem label="姓名" :label-width="85" label-position="left" prop="name">
                                    <Input v-model="evalData.name" disabled></Input>
                                </FormItem>
                            </Col>
                            <Col span="9">
                                <FormItem label="性别" prop="gender">
                                    <RadioGroup v-model="evalData.gender" label-position="left">
                                        <Radio label="男"></Radio>
                                        <Radio label="女"></Radio>
                                    </RadioGroup>
                                </FormItem>
                            </Col>
                            <Col span="12">
                                <FormItem label="职位" :label-width="85" label-position="left" prop="position">
                                    <Select v-model="evalData.position" disabled>
                                        <Option value="组长">组长</Option>
                                        <Option value="副组长">副组长</Option>
                                        <Option value="客服">客服</Option>
                                        <Option value="技术支持工程师">技术支持工程师</Option>
                                    </Select>
                                </FormItem>
                            </Col>
                            <Col span="11">
                                <FormItem label="电话" label-position="left" prop="phone">
                                    <Input v-model="evalData.phone"></Input>
                                </FormItem>
                            </Col>
                            <Col span="22">
                                <FormItem label="主要负责系统" :label-width="100" label-position="left" prop="system">
                                        <Input v-model="evalData.system" type="text"></Input>
                                </FormItem>
                            </Col>
                            <Col span="22">
                                <FormItem label="主要工作内容" :label-width="100" label-position="left" prop="desc">
                                        <Input v-model="evalData.desc" type="textarea" :autosize="{minRows: 2,maxRows: 5}" placeholder="请输入工作内容..." style="resize:none;"></Input>
                                </FormItem>
                            </Col>
                            <Col span="24">
                                <FormItem class="act-btn-group">
                                    <Button type="primary" @click="handleSubmit('evalData')" size="large">确定</Button>
                                    <Button type="default" @click="closeModal" size="large">取消</Button>
                                </FormItem>
                            </Col>
                        </Row>
                    </Form>
                </div>
			</Modal>
		</Layout>
	</div>
</template>

<script>
// api util和接口列表
import api from '@/api/axiosApi'
import operationApiList from '@/api/operationApiList'

export default {
    data() {
        return {
            // 职务列表
            perList: [],
            currentOrgId: '',
            currentDeptId: '',
            systemCode: '',
            modal: false,
            queryTime:['2018-06-01', '2018-07-01'],
            evalData:{
                name:'男',
                gender:'组长',
                position:'',
                phone:'',
                system:'',
                desc:''
            },
            ruleValidate: {
                name:[
                    { required:true,message:'姓名不能为空' }
                ],
                gender:[
                    { required:true,message:'选项不能为空' }
                ],
                position:[
                    { required:true,message:'选项不能为空' }
                ],
                phone:[
                    { required:true,message:'电话号码不能为空' }
                ],
                system:[
                    { required:true,message:'系统描述不能为空' }
                ],
                desc:[
                    { required:true,message:'工作内容不能为空' }
                ]
            },
            columns: [{
                    type: 'index',
                    title: '序号',
                    width: 80,
                    align: 'center'
                },
                {
                    type: 'selection',
                    width: 60,
                    align: 'center'
                },
                {
                    title: '编号',
                    key: 's1'
                },
                {
                    title: '姓名',
                    width: 100,
                    key: 's2'
                },
                {
                    title: '性别',
                    width: 80,
                    key: 's3'
                },
                {
                    title: '职位',
                    width: 150,
                    key: 's4'
                },
                {
                    title: '电话',
                    width: 150,
                    key: 's5'
                },
                {
                    title: '主要工作内容',
                    key: 's6'
                },
                {
                    title: '主要负责系统',
                    key: 's7'
                },
                {
                    title: '操作',
                    key: 'act',
                    align: 'center',
                    render: (h, params) => {
                        return h('div', [
                            h('Button', {
                                props: {
                                    type: 'primary',
                                    size: 'small'
                                },
                                style: {
                                    marginRight: '15px'
                                },
                                on: {
                                    click: () => {
                                        this.modal = true;
                                    }
                                }
                            }, '编辑'),
                            h('Button', {
                                props: {
                                    type: 'primary',
                                    size: 'small'
                                },
                                on: {
                                    click: () => {
                                        this.modal = true;
                                    }
                                }
                            }, '详情')
                        ]);
                    }
                },
            ],
            data: [{
                s1: 'yw-zz-001',
                s2: '***',
                s3: '男',
                s4: '组长',
                s5: '13111111111',
                s6: '全面负责运维服务小组工作',
                s7: '权限管理系统；统一监管平台',
            }, {
                s1: 'yw-zz-001',
                s2: '***',
                s3: '男',
                s4: '组长',
                s5: '13111111111',
                s6: '全面负责运维服务小组工作',
                s7: '权限管理系统；统一监管平台',
            }]
        }
    },
    components:{
    },
    mounted () {
        this.findOrgAndDpmOperationTree()
    },
    methods:{
        // 获取运维单位树
        findOrgAndDpmOperationTree() {
            const vm = this
            api(operationApiList.findOrgAndDpmOperationTree)
            .then(res => {
                if (res.data.errcode === 0) {
                    vm.perList = res.data.data
                    if (vm.perList.length > 0) {
                        vm.currentOrgId = vm.perList[0].id
                        vm.systemCode = vm.perList[0].dpms[0].systemCode || 'gxqpt'
                        vm.currentDeptId = vm.perList[0].dpms[0].id
                    }
                }
            },(error) => {console.log(error)})
        },
        // 根据部门id查询人员列表
        getDeptPerson() {
            const vm = this
            api(operationApiList.getDeptPerson, {
                data: {
                    // 单位id
                    mainorgid: vm.currentOrgId,
                    // 部门id
                    maindeptid: vm.currentDeptId,
                    // 体系
                    systemCode: vm.systemCode,
                },
                pageNo: 1,
                pageSize: 10
            }).then(res => {
                if (res.data.errcode === 0) {
                    vm.perList = res.data.data
                }
            },(error) => {console.log(error)})
        },
        openModal(status) {
            if(status){
                document.querySelector('.ivu-modal-footer').style.display = 'none';
            }else{
                this.$refs['evalData'].resetFields();
            }
        },
        closeCallBack(status) {
            if(!status) {
                this.$refs['interfaceData'].resetFields();
            }
        },
        closeModal() {
            this.modal = false;
        },
        addBackup(){
            this.modal = true;
        },
        handleSubmit() {
            console.log("确定");
            this.$refs['evalData'].validate((valid) => {
                console.log(valid);
                if(valid) {
                    console.log("验证成功");
                } else {
                    console.log(this.$refs['modal'])
                    this.$Message.error('表单验证失败!');
                }
            })
        },
        changeItem (systemCode, orgId, deptId) {
            this.currentOrgId = orgId
            this.currentDeptId = deptId
            this.systemCode = systemCode || 'gxqpt'
            this.getDeptPerson()
        }
    },
    watch: {
        currentDeptId () {
            this.getDeptPerson()
        }
    }
}
</script>

<style type="text/css" scoped>
.wAuto{
	width: 100%;
}
.queryTime{
	width: 200px;
}
.flow{
	margin-top: 20px ;
}
</style>