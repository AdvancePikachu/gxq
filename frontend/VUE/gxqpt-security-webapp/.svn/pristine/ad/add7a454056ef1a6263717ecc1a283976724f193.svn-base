<!-- 分配资源 -->
<!-- 暂时无法想象如何开发，等待UI -->
<template>
    <Content>
        <Form v-for="(item,idx) in applyData" :key="idx" :label-width="80" style="margin:80px 0;">
            <Row>
                <Col span="5">
                    <FormItem label="CPU核数">
                        <Input :value="item.cpuCount+'核'" disabled></Input>
                    </FormItem>
                </Col>
                <Col span="5">
                    <FormItem label="内存">
                        <Input :value="item.memorySize+'GB'" disabled></Input>
                    </FormItem>
                </Col>
                <Col span="5">
                    <FormItem label="网络区域">
                        <Input :value="item.netScope" disabled></Input>
                    </FormItem>
                </Col>
                <Col span="5">
                    <FormItem label="网络带宽">
                        <Input :value="item.netWide+'M'" disabled></Input>
                    </FormItem>
                </Col>
            </Row>
            <Row>
                <Col span="5">
                    <FormItem label="操作系统">
                        <Input :value="item.system" disabled></Input>
                    </FormItem>
                </Col>
                <Col span="5">
                    <FormItem label="系统盘">
                        <Input :value="item.sysDisksize+'GB'" disabled></Input>
                    </FormItem>
                </Col>
                <Col span="5" v-for="(disk,idx2) in item.disks" :key="idx2">
                    <FormItem :label="disk.diskName">
                        <Input :value="disk.diskSize+'GB'" disabled></Input>
                    </FormItem>
                </Col>
                <Col span="5">
                    <FormItem label="数量">
                        <Input :value="item.applyCount" disabled></Input>
                    </FormItem>
                </Col>
            </Row>
            <Button type="primary" @click="tableCreate(item)">分配</Button>
            <Table class="tableList" v-if="tableShow" :columns="tableList.columns" :data="tableList.data" disabled-hover></Table>
        </Form>
        <Row class="bottom-bar" style="text-align: center">
            <Col>
                <Button type="default" @click="quit(-2)">取消</Button>
                <Button type="primary" @click="quit(-1)">上一步</Button>
                <Button type="primary" @click="submit">提交</Button>
            </Col>
        </Row>
    </Content>
</template>

<script>
import api from '@/api/axiosApi'
import softhardApiList from '@/api/softhardApiList'

function getConfigInfo() {
  return {
    serverID:'',
    serverIP:'',
    disksID:[],
    disksMount:[],
    diskProperty:[],
  }
}
export default {
    data(){
        return{
            applyData:[],//获取传递的数据如内存、CPU等
            tableData:[],//表格数据
            subData:{
                dealServer:[],
            },//提交数据整理
            tableIdx:0,//父级table的index值
            tableShow:false,//table显示判断
            disksID:{id:''},//磁盘id默认模块
            disksMount:{mount:''},//挂载点默认模块
            diskProperty:{property:'数据盘'},//磁盘属性默认模块
            disksIDColumns:[
                {
                    title:'磁盘ID',
                    key:'id',
                    render: (h, params) => {
                        return h('Input', {
                            class:'server-list',
                            props: {
                                clearable:true,
                            },
                            on: {
                                input: (value) => {
                                    this.dealServerApp(this.subData,params);
                                    this.subData.dealServer[this.tableIdx].disks[params.index].diskId = value;
                                }
                            }
                        })
                    }
                }
            ],
            disksMountColumns:[
                {
                    title:'挂载点',
                    key:'mount',
                    render: (h, params) => {
                        return h('Input', {
                            class:'server-list',
                            props: {
                                clearable:true,
                            },
                            on: {
                                input: (value) => {
                                    this.dealServerApp(this.subData,params);
                                    this.subData.dealServer[this.tableIdx].disks[params.index].diskPath = value;
                                }
                            }
                        })
                    }
                }
            ],
            diskPropertyColumns:[
                {
                    title:'磁盘属性',
                    key:'property',
                    align: 'center',
                    render:(h,params) => {
                        const idx = params.index;
                        const property = params.row.property;//默认第一个为系统盘
                        return h('span', {
                            domProps: {
                                innerHTML: property
                            },
                        })
                    }
                    // render: (h, params) => {
                    //     return h('Input', {
                    //         props:{
                    //             value:'',
                    //             label:'',
                    //             disabled:true
                    //         },
                    //         on: {
                    //             'on-keyup':(event) => {
                    //                 console.log(params);
                    //                 console.log(event);
                    //                 this.dealServerApp(this.subData,params);
                    //                 this.subData.dealServer[this.tableIdx].disks[params.index].diskType = event;
                    //             }
                    //         }

                    //     },
                    //     [
                    //         h('Option',{
                    //             props: {
                    //                 value: '1'
                    //             }
                    //         },'数据盘'),
                    //         h('Option',{
                    //             props: {
                    //                 value: '2'
                    //             }
                    //         },'系统盘')
                    //     ])
                    // }
                }
            ],
            tableList: {
                columns: [
                    {
                        type: 'index',
                        title: '序号',
                        width: 80,
                        align: 'center'
                    },
                    {
                        title: '服务器ID',
                        key: 'serverID',
                        render: (h, params) => {
                            return h('Input', {
                                class:'server-list',
                                props: {
                                    clearable:true,
                                },
                                on: {
                                    input: (value) => {
                                        if(!this.subData.dealServer[params.index]){
                                            this.subData.dealServer[params.index] = {};
                                        }
                                        this.subData.dealServer[params.index].serverId = value;
                                    }
                                }
                            })
                        }
                    },
                    {
                        title: '服务器ip',
                        key: 'serverIP',
                        render: (h, params) => {
                            return h('Input', {
                                class:'server-list',
                                props: {
                                    clearable:true,
                                },
                                on: {
                                    input: (value) => {
                                        if(!this.subData.dealServer[params.index]){
                                            this.subData.dealServer[params.index] = {};
                                        }
                                        this.subData.dealServer[params.index].ip = value;
                                    }
                                }
                            })
                        }
                    },
                    {
                        title: '磁盘ID',
                        key: 'disksID',
                        align: 'center',
                        render: (h, params) => {
                            return h('Table', {
                                class:'server-list',
                                props: {
                                    columns: this.disksIDColumns,
                                    data:params.row.disksID,
                                    'show-header':false
                                },
                                on: {
                                    'on-row-click': (value) => {
                                        this.tableIdx = params.index;//获取父表格的index
                                    }
                                }
                            })
                        }
                    },
                    {
                        title: '挂载点',
                        key: 'disksMount',
                        align: 'center',
                        render: (h, params) => {
                        return h('Table', {
                            class:'server-list',
                            props: {
                                columns: this.disksMountColumns,
                                data:params.row.disksMount,
                                'show-header':false
                            },
                            on: {
                                'on-row-click': (value) => {
                                    this.tableIdx = params.index;//获取父表格的index
                                }
                            }
                        })
                        }
                    },
                    {
                        title: '磁盘属性',
                        key: 'diskProperty',
                        align: 'center',
                        render: (h, params) => {
                        return h('Table', {
                            class:'server-list',
                            props: {
                                columns: this.diskPropertyColumns,
                                data:params.row.diskProperty,
                                'show-header':false
                            },
                            on: {
                                'on-row-click': (value) => {
                                    this.tableIdx = params.index;//获取父表格的index
                                }
                            }
                        })
                        }
                    },
                ],
                data: []
            },
        }
    },
    mounted(){
        if(this.$route.params.table){
            this.applyData = this.$route.params.table;
        }
        console.log(this.$route.params.table);
    },
    methods:{
        quit (n) {// 取消
            this.$router.go(n)
        },
        tableCreate(item){//表格整理然后显示；
            console.log(item);
            this.tableData = [];//表格数据初始化
            for(var i = 0;i<item.applyCount;i++){
                this.tableData.push(getConfigInfo());
                for(var j =0;j<=item.disks.length;j++){
                    this.tableData[i].disksID.push(this.disksID);//根据数量遍历磁盘ID
                    this.tableData[i].disksMount.push(this.disksMount);//根据数量遍历挂载点
                    this.tableData[i].diskProperty[j] = { property:''};//根据数量遍历并且初始化磁盘属性
                    if(j==0){
                        this.tableData[i].diskProperty[j].property = '系统盘('+item.sysDisksize+'GB)';
                    }else{
                        this.tableData[i].diskProperty[j].property = item.disks[j-1].diskName + '(' + item.disks[j-1].diskSize + 'GB)';
                    }
                }
            }
            this.tableList.data = this.tableData;
            this.tableShow = true;
        },
        submit(){//提交
            this.dataDeal(this.subData)
            if(this.dataDeal(this.subData)){
                api(softhardApiList.uYApproveSubmit,this.subData).then((res) => {
                    if(res.data.errcode == 0){
                        this.$Message.success('提交成功');
                        this.$router.push({
                            name: 'applyMgr',
                        })
                    }else{
                        this.$Message.error(res.data.errmsg);
                    }
                }, (err) => {
                    //dong something...
                })
            }
        },
        dataDeal(data){
            console.log(this.applyData);
            data.stepCode = 'YOUYI_HANDLER';//this.$route.params.departData.stepCode;假数据
            data.applyKeyid = this.$route.params.departData.id;
            data.dealServer.forEach((item,index) => {
                item.disks.forEach((items,idx) =>{
                    if(idx==0){
                        items.diskName = '系统盘';
                        console.log(this.applyData[index]);//不加这段代码会报错找不到sysDisksize
                        items.diskSize = this.applyData[index].sysDisksize;
                        items.diskType = '2'
                    }else{
                        console.log(this.applyData[index]);
                        console.log(idx);
                        items.diskName = this.applyData[index].disks[idx-1].diskName;
                        items.diskSize = this.applyData[index].disks[idx-1].diskSize;
                        items.diskType = '1'
                    }
                    console.log(items);
                });
                item.applyKeyid = this.$route.params.departData.id;
                item.cpuCount = this.applyData[index].cpuCount;
                item.applyKeyid = this.$route.params.departData.id;
                item.memorySize = this.applyData[index].memorySize;
                item.netScope = this.applyData[index].netScope;
                item.netWide = this.applyData[index].netWide;
                item.system = this.applyData[index].system;
            });
            return true;
        },
        dealServerApp(data,params){
            if(!data.dealServer[this.tableIdx]){
                data.dealServer[this.tableIdx] = {};
            }
            if(!data.dealServer[this.tableIdx].disks){
                data.dealServer[this.tableIdx].disks =[];
            }
            if(!data.dealServer[this.tableIdx].disks[params.index]){
                data.dealServer[this.tableIdx].disks[params.index] = {}
            }
        }
    }
}
</script>

<style lang="less" scoped>
.server-list /deep/ thead{
    display: none;
}
.tableList{
    margin-top:30px;
}
.tableList input{
    border: 0px;outline:none;
}
.tableList /deep/.ivu-table-cell{
    overflow: inherit;
}
.tableList /deep/.ivu-table{
    overflow: inherit;
}

</style>
