<template>
    <Modal
        v-model="modalShow"
        :title="title || '详情'"
        class-name="vertical-center-modal"
        width="40%"
        :closable="false"
        :mask-closable="false">
        <div style="text-align:center">
            <Form ref="formData" :model="formData" :rules="ruleValidate" :label-width="70" class="clearfix">
                <Row :gutter="40">
                    <Col span="24">
                        <FormItem label="培训类别" prop="trainType">
                            <template v-if="isEdit">
                                <Select v-model="currentTypeIdx">
                                    <Option :value="i" v-for="(item, i) in typeList" :key="i">{{item.type}}</Option>
                                </Select>
                            </template>
                            <template v-else>
                                <Input v-model="formData.trainType" disabled></Input>
                            </template>
                        </FormItem>
                    </Col>
                    <Col span="12">
                        <FormItem label="培训名称" prop="trainName">
                            <template v-if="isEdit && currentTypeIdx !== (typeList.length - 1)">
                                <Select v-model="formData.trainName">
                                    <Option :value="item" v-for="item in names" :key="item">{{item}}</Option>
                                </Select>
                            </template>
                            <template v-else>
                                <Input v-model="formData.trainName" :disabled="!(isNew || isEdit)"></Input>
                            </template>
                        </FormItem>
                    </Col>
                    <Col span="12">
                        <FormItem label="培训时间" prop="trainTime">
                            <DatePicker
                                type="date"
                                v-model="formData.trainTime"
                                show-week-numbers
                                placement="bottom-end"
                                placeholder="请选择培训时间"
                                style="float: left; width: 100%;">
                            </DatePicker>
                        </FormItem>
                    </Col>
                    <Col span="24">
                        <FormItem label="培训地址" prop="trainAddress">
                            <Input v-model="formData.trainAddress"></Input>
                        </FormItem>
                    </Col>
                    <Col span="24">
                        <FormItem label="培训内容" :label-width="72" prop="trainInfo">
                            <Input
                                v-model="formData.trainInfo"
                                type="textarea"
                                :autosize="{minRows: 5,maxRows: 5}"
                                style="resize:none;"
                                :disabled="!(isNew || isEdit)">
                            </Input>
                        </FormItem>
                    </Col>
                </Row>
            </Form>
        </div>
        <div slot="footer">
            <Button class="modalBtn" type="primary" @click="handleSubmit" size="large">确定</Button>
            <Button class="modalBtn" type="default" @click="closeModal" size="large">取消</Button>
        </div>
    </Modal>
</template>

<script>
export default {
    data() {
        const validRules = {
            trainTime (rule, value, callback) {
                if (value.length === 0) {
                    callback(new Error('请选择日期！'))
                } else {
                    callback()
                }
            }
        }
        return {
            // 当前选择的类型的序号
            currentTypeIdx: 0,
            modalShow: false,
            formData: {
                trainType: '',
                trainName: '',
                trainTime: '',
                trainAddress: '',
                trainInfo: ''
            },
            ruleValidate: {
                trainType: [{required: true, message: '不可为空', trigger: 'blur'}],
                trainName: [{required: true, message: '不可为空', trigger: 'blur'}],
                trainTime: [{required: true, validator: validRules.trainTime, trigger: 'blur'}],
                trainAddress: [{required: true, message: '不可为空', trigger: 'blur'}],
                trainInfo: [{required: true, message: '不可为空', trigger: 'blur'}]
            }
        }
    },
    props: {
        // 弹窗title
        title: String,
        // 表单信息
        detailData: {
            type: Object,
            default: () => {
                return {}
            }
        },
        // 自定义
        isNew: {
            type: Boolean,
            default: false
        },
        // 修改
        isEdit: {
            type: Boolean,
            default: false
        },
        // 类型列表
        typeList: {
            type: Array,
            default: () => {
                return []
            }
        }
    },
    computed: {
        names () {
            if (this.currentTypeIdx === this.typeList.length - 1 || this.typeList.length === 0) {
                return []
            }
            return this.typeList[this.currentTypeIdx].names
        }
    },
    methods: {
        handleSubmit() {
            const vm = this
            console.log("验证表单")
            vm.$refs['formData'].validate((valid) => {
                if(valid) {
                    vm.$emit('on-ok', vm.formData)
                    vm.closeModal()
                } else {
                    vm.$Message.error('表单验证失败!')
                }
            })
        },
        validForm() {
            this.$refs['formData'].resetFields()
            this.$refs['formData'].validate()
        },
        open () {
            this.modalShow = true
            this.$refs['formData'].resetFields()
            this.initDetail()
        },
        closeModal() {
            this.modalShow = false
        },
        initDetail() {
            const vm = this
            vm.formData = {
                trainType: vm.detailData.type || '',
                trainName: vm.detailData.name || '',
                trainTime: vm.detailData.trainTime || '',
                trainAddress: vm.detailData.trainAddress || '',
                trainInfo: vm.detailData.context || ''
            }
            // 修改
            if (vm.isEdit) {
                const detailType = vm.detailData.type
                for (var i = 0; i < vm.typeList.length; i++) {
                    if (vm.typeList[i].type === detailType) {
                        vm.currentTypeIdx = i
                        break
                    }
                }
            }
            // 新建自定义
            if(vm.isNew) {
                vm.formData.trainType = '自定义培训'
            }
        }
    }
}
</script>

<style scoped>
.ivu-form-item >>> .ivu-form-item-content {
    height:auto;
}
.ivu-input-wrapper >>> textarea {
    resize: none;
}
.modalBtn{
    margin:0 20px;
}
</style>
