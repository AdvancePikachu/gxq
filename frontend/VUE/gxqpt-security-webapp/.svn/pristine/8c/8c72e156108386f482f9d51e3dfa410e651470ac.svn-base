/* eslint-disable */
import $ from './jquery-3.3.1.min.js'
import './config.js'
import store from '@/store'
window.hy_auth_login=function (systemCode){
	console.log('hy_auth_login....')
	if(!loginConfig){
		
		console.log("请加载登录配置信息")
		return ;
	}
	var loginController = {};
	
	loginController.isLogined = function (){
		var token = loginController.getUserToken();
		return token?true:false;
	}
	
	loginController.getLoginUserInfo = function (){
		
		var loginInfo = window.sessionStorage._token;
		if(loginInfo){
			return eval("("+loginInfo+")");
		}
		return null;
	}
	loginController.setLoginUserInfo = function(token){
	
		window.sessionStorage._token = token;
		store.commit('getUserInfo');
		
	}
	loginController.emptyLoginUserInfo = function(){
		
		delete window.sessionStorage._token;
	}
	loginController.loginFlow = function(){
		if(this.isLogined()){
			return ;
		}
		var token = this.getRequestParamToken();
		if(token){
			this.getLoginInfo(token);
		}else{
			this.toLogin();
		}
	}
	
	loginController.toLogin = function(){
		
		location.href=this.getLoginUrl();
	}
	
	loginController.getLoginUrl = function (){
		if(systemCode=="softhard"){//软硬件管理平台
			return loginConfig.sso_login_url + "?service=" + loginConfig.softhard_local_service_url;
		}else if(systemCode=="security"){//安全保障平台
			return loginConfig.sso_login_url + "?service=" + loginConfig.security_local_service_url;
		}else if(systemCode=="supervise"){//统一监管平台
			return loginConfig.sso_login_url + "?service=" + loginConfig.supervise_local_service_url;
		}else if(systemCode=="operation"){//运维管理平台
			return loginConfig.sso_login_url + "?service=" + loginConfig.operation_local_service_url;
		}
	}
	
	loginController.getRequestParamToken = function(){
		
		var para=window.location.search;//当前请求的url的参数部分
		return loginController.GetQueryString(para,"token");
	}
	
	
	//根据参数部分和参数名来获取参数值
	loginController.GetQueryString = function (paraPart,name) {
	    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
	    var r = paraPart.substr(1).match(reg);
	    if (r != null) return unescape(r[2]); return null;
	}
	/**
	 * 获取用户级token
	 */
	loginController.getUserToken = function (){
		
		var loginUserInfo = this.getLoginUserInfo();
		return loginUserInfo && loginUserInfo.token;
	}
	/**
	 * 获取登录人的名字
	 */
	loginController.getUserName = function (){
		
		var loginUserInfo = this.getLoginUserInfo();
		return loginUserInfo && loginUserInfo.name;
	}
	/**
	 * 获取登录人的id
	 */
	loginController.getUserId = function (){
		
		var loginUserInfo = this.getLoginUserInfo();
		return loginUserInfo && loginUserInfo.userid;
	}
	/**
	 * 获取登录人的账号
	 */
	loginController.getUserAccount = function (){
		
		var loginUserInfo = this.getLoginUserInfo();
		return loginUserInfo && loginUserInfo.account;
	}
	
	loginController.getLoginInfo = function (token){
		
		$.ajax({
			
			url: loginConfig.sso_validate_url +"?token="+token+"&appKey="+loginConfig.appKey,
			type:"post",
			dataType:"json",
			success:function (r){
				console.log(r);
				if(r && r.logined){
					console.log(r);
					loginController.setLoginUserInfo(JSON.stringify(r));
					loginController.toLogin();
				} else{
					loginController.toLogin();
				}
				
			}
		});
	}

	window.loginController = loginController;
	
	loginController.loginFlow();
};