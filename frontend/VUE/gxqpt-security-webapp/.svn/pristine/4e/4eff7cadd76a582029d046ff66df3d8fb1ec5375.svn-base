<template>
  <div class="wAuto">
    <Layout>
      <Content>
        <Breadcrumb>
          <BreadcrumbItem>运维文档管理</BreadcrumbItem>
          <BreadcrumbItem>运维文档查询</BreadcrumbItem>
        </Breadcrumb>
        <Card>
          <Form ref="formValidate" inline :label-width="90">
            <FormItem label="文档类别">
              <div class="ivu-form-item-content" @click="getTypeTree">
                <div class="ivu-input-wrapper ivu-input-type">
                  <i class="ivu-icon ivu-icon-load-c ivu-load-loop ivu-input-icon ivu-input-icon-validate"></i>
                  <div class="ivu-input" style="width: 160px;">{{typeInfo.title}}</div>
                </div>
              </div>
            </FormItem>
            <FormItem label="文档编号">
              <Input type="text" v-model="formData.code"></Input>
            </FormItem>
            <FormItem label="文档名称">
              <Input type="text" v-model="formData.name"></Input>
            </FormItem>
            <FormItem label="上传人">
              <Input type="text" v-model="formData.createUserName"></Input>
            </FormItem>
            <FormItem label="上传时间">
              <DatePicker
                class="queryTime"
                v-model="formData.queryTime"
                format="yyyy-MM-dd"
                type="daterange"
                placement="bottom-end"
                placeholder="请选择日期">
              </DatePicker>
            </FormItem>
            <FormItem>
              <Button type="info" @click="getDocList">查询</Button>
              <Button type="info" @click="resetCondition">重置</Button>
            </FormItem>
          </Form>
          <Row style="margin-bottom: 20px;">
            <Col>
              <Button type="primary" @click="downPackage">下载</Button>
            </Col>
          </Row>
          <Table border ref="selection" :columns="columns" :data="docList" @on-selection-change="doSelect"></Table>
          <div class="bottom-bar">
            <Page :total="pageInfo.total" show-sizer show-elevator></Page>
          </div>
        </Card>
      </Content>
      <Modal
        v-model="typeModal"
        title="文档类别选择"
        class-name="vertical-center-modal"
        width="40%">
        <Tree ref="typeTree" :data="typeTree" empty-text="暂无文档类别"></Tree>
        <div slot="footer">
          <Button class="modalBtn" type="primary" @click="selectType" size="large">确定</Button>
          <Button class="modalBtn" type="default" @click="typeModal = false" size="large">取消</Button>
        </div>
      </Modal>
    </Layout>></h3>
    
  </div>
</template>

<script>
import api from '@/api/axiosApi'
import operationApiList from '@/api/operationApiList'

function getDateRange(time) {
  if (!time) {
    return ''
  }
  // 结束日期
  const endDate = new Date(time)
  // 当前日期往前推30天
  const startDate = new Date(time - 30 * 24 * 60 * 60 * 1000)
  return {
    start: `${startDate.getFullYear()}-${startDate.getMonth() + 1}-${startDate.getDate()}`,
    end: `${endDate.getFullYear()}-${endDate.getMonth() + 1}-${endDate.getDate()}`
  }
}

function handleTreeData(data) {
  data.map((value, idx) => {
    if (value.children && value.children.length > 0) {
      data[idx].disableCheckbox = true
      // 默认打开树结构
      // data[idx].expand = true
      data[idx].children = handleTreeData(data[idx].children)
    }
  })
  return data
}
let isManage = false
export default {
  data() {
    const vm = this
    const date = getDateRange(Date.now())
    return {
      // 已选列表的值
      selections: [],
      // 选择信息类型的弹窗
      typeModal: false,
      modal: false,
      // 分页信息
      pageInfo: {
        pageNo: 1,
        pageSize: 10,
        total: 0
      },
      formData: {
        code: '',
        name: '',
        createUserName: '',
        // 初始化开始时间和结束时间
        queryTime: [date.start, date.end],
      },
      // 文档类别信息
      typeInfo: {
        // 类型名称
        title: '',
        // 类型id
        id: ''
      },
      columns: [{
        type: 'selection',
        width: 60,
        align: 'center'
      },
      {
        title: '文档名称',
        key: 'name'
      },
      {
        title: '文档编号',
        key: 'code'
      },
      {
        title: '文档类别',
        key: 'classifyName'
      },
      {
        title: '文档描述',
        key: 'description'
      },
      {
        title: '上传时间',
        key: 'createTime'
      },
      {
        title: '上传人',
        key: 'createUserName'
      },
      {
        title: '下载次数',
        key: 'downloadCount',
        width: 90
      },
      {
        title: '操作',
        key: 'act',
        align: 'center',
        minWidth: 100,
        render: (h, params) => {
          const documentId = params.row.documentId
          const {userid, token} = vm.$store.state.userInfo
          // const preview = h('Button', {
          //   props: {
          //     type: 'primary',
          //     size: 'small'
          //   },
          //   on: {
          //     click: () => {
          //       this.modal = true
          //     }
          //   }
          // }, '预览')
          const download = h('a', {
            attrs: {
              href: `/api/file/p/file/down?id=${documentId}&userId=${userid}&token=${token}`,
              target: '_blank'
            }
          }, [h('Button', {
            props: {
              type: 'primary',
              size: 'small'
            }
          }, '下载')])
          const fileDelete = h('Button', {
            props: {
              type: 'primary',
              size: 'small'
            },
            on: {
              click: () => {
                alert('删除')
              }
            }
          }, '删除')
          const act = isManage ? [download, fileDelete] : [download]
          return h('div', {
            attrs: {
              class: 'act-container'
            }
          }, act)
        }
      }],
      docList: [],
      // 信息类型list
      typeTree: []
    }
  },
  computed: {
    // 判断是管理还是查询，1是管理
    isManage() {
      isManage = this.$route.params.manage === '1'
      return isManage
    },
    // 请求文件列表的地址
    fileQueryUrl() {
      return this.isManage ? 'fileManageQuery' : 'fileQuery'
    }
  },
  mounted () {
    this.$nextTick(() => {
      this.getDocList()
    })
  },
  methods: {
    // 获取所有文档的列表
    getDocList () {
      const vm = this
      const endTime = getDateRange(vm.formData.queryTime[1]).end
      const startTime = getDateRange(vm.formData.queryTime[0]).end
      api(operationApiList[vm.fileQueryUrl], {
        pageNo: vm.pageInfo.pageNo,
        pageSize: vm.pageInfo.pageSize,
        data: {
          classifyId: vm.typeInfo.id,
          sord: 'asc',
          createTimeEnd: endTime ? `${endTime} 23:59:59` : '',
          createTimeStart: startTime ? `${startTime} 00:00:00` : '',
          ...vm.formData
        }
      }).then(res => {
        if (res.data.errcode === 0) {
          vm.selections = []
          vm.docList = res.data.data.list
          vm.pageInfo.total = Number(res.data.data.total)
        }
      }, error => {console.log(error)})
    },
    // 获取文档类型的树结构
    getTypeTree() {
      const vm = this
      vm.typeModal = true
      if (vm.typeTree.length > 0) {
        return
      }
      api(operationApiList.getTypeTree, {
        id: ''
      }).then(res => {
        if (res.data.errcode === 0) {
          const tree = JSON.parse(JSON.stringify(res.data.data).replace(/name/g, 'title'))
          vm.typeTree = handleTreeData(tree)
        }
      }, error => {console.log(error)})
    },
    // 确定选择的文档类型
    selectType() {
      const vm = this
      const obj = vm.$refs.typeTree.getSelectedNodes()
      // if (obj.length === 0) {
      //   vm.$Message.error('请选择节点')
      //   return
      // }
      if (obj[0].children && obj[0].children.length > 0) {
        vm.typeInfo = {
          title: '',
          id: ''
        }
        return
      }
      vm.typeInfo = obj[0]
      vm.typeModal = false
    },
    resetCondition() {
      Object.assign(this.$data.formData, this.$options.data().formData)
      Object.assign(this.$data.typeInfo, this.$options.data().typeInfo)
    },
    // 勾选列表时触发
    doSelect(selection) {
      this.selections = selection
    },
    // 批量下载
    downPackage() {
      const vm = this
      const {userid, token} = vm.$store.state.userInfo
      const ids = []
      if (vm.selections.length === 0) {
        vm.$Message.info('请先勾选要下载的文件!')
        return
      }
      vm.selections.map(item => {
        ids.push(item.documentId)
      })
      const url = `/api/file/p/file/downloadpackage?ids[]=${ids.join(',')}&userId=${userid}&token=${token}`
      window.open(url)
    }
  },
  watch: {
    '$route' () {
      const vm = this
      const {selections, typeModal, modal, pageInfo, formData, typeInfo, docList, typeTree} = vm.$options.data()
      vm.selections = selections
      vm.typeModal = typeModal
      vm.modal = modal
      vm.pageInfo = pageInfo
      vm.formData = formData
      vm.typeInfo = typeInfo
      vm.docList = docList
      vm.typeTree = typeTree
      vm.$nextTick(() => {
        vm.getDocList()
      })
    }
  }
}
</script>

<style type="text/css" scoped>
.wAuto{
  width: 100%;
}
.queryTime{
  width: 200px;
}
.flow{
  margin-top: 20px ;
}
</style>

<style lang="less">
.act-container button{
  margin: 0 5px !important;
}
</style>