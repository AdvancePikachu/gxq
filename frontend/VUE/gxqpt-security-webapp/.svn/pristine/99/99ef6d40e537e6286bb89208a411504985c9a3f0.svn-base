<template>
    <Layout>
		<Content>
			<Breadcrumb>
				<BreadcrumbItem>统一监管平台</BreadcrumbItem>
				<BreadcrumbItem>部门预警分析</BreadcrumbItem>
			</Breadcrumb>
			<Card>
				<Form ref="formValidate" :model='formData' :rules="ruleValidate" inline :label-width="100">
					<FormItem label="时间">
                        <DatePicker :value="defaultDate" @on-change="changeYear" type="year" placeholder="选择时间" style="width: 200px"></DatePicker>
					</FormItem>
					<FormItem label="单位">
						<Select v-model="formData.unitName" style="width:180px">
							<Option v-for="(item, index) in unitOrgIds" :key="index" :value="item.id">{{item.name}}</Option>
						</Select>
					</FormItem>
					<FormItem>
						<!-- <router-link to="/unitWarnAnalyzeView/unit"><Button type="info">查看分析</Button></router-link> -->
						<Button type="info" @click="refreshAnalyze">查看分析</Button>
					</FormItem>
				</Form>
			</Card>
        <Layout style="background:#fff;">
            <carouseList :data='unitList' :arrowType='arrowType'></carouseList>
            <Layout>
                <Col span="14"></Col>
                <Col span="9"></Col>
                <Row type="flex" justify="space-between">
                  <Col span="11">
                    <chart-card title="各部门预警状态">
                      <unitWarnState ref="unitWarnState" />
                    </chart-card>
                  </Col>
                  <Col span="11">
                    <chart-card title="各部门预警类别情况">
                      <unit-category ref="unitCategorye" />
                    </chart-card>
                  </Col>
                </Row>
                <Row type="flex" justify="space-between">
                  <Col span="11">
                    <chart-card title="各部门预警处理对比分析">
                      <unit-manage ref="unitManageData" />
                    </chart-card>
                  </Col>
                  <Col span="11">
                    <chart-card title="各部门预警级别情况">
                      <unit-level ref="unitLevel" />
                    </chart-card>
                  </Col>
                </Row>
            </Layout>
        </Layout>
		</Content>
	</Layout>    
</template>

<script>
import api from '@/api/axiosApi'
import superviseApiList from '@/api/superviseApiList'
// echart图外层容器，包括卡片样式
import chartCard from './echarts/chartCard.vue'
import countUp from '@/components/hengyun/countUp.vue'
// 各部门预警状态
import unitWarnState from './echarts/unitWarnState.vue'
// 各部门预警类别情况
import unitCategory from './echarts/unitCategory.vue'
// 各部门预警处理对比分析
import unitManage from './echarts/unitManage.vue'
// 各部门预警级别情况
import unitLevel from './echarts/unitLevel.vue'
// 顶部滑动列表模块
import carouseList from "./modal/carouseList.vue";
export default {
    components: {
      'chart-card': chartCard,
      countUp,
      unitWarnState,
      carouseList,
      'unit-category': unitCategory,
      'unit-manage': unitManage,
      'unit-level': unitLevel
    },
    data(){
        return{
            arrowType:'never',
            unitList:[],//部门列表
            defaultDate:new Date(),//获取今年年份
            orgId:'',
            dpmIds:[],//初始化部门集合
            unitOrgIds:[],//初始化单位集合
            ruleValidate:{},
            formData:{
              year:new Date().getFullYear(),
              unitName:''
            },
            echartDatas:{},
        }
    },
    mounted(){
        //初始化
        let date = new Date();
        let year = date.getFullYear().toString();
        this.init(year);
    },
    methods:{
        init(year){
            this.getUnitData(year);
            this.getDepartmentData(year);
        },
        getUnitData(year){//获取基本单位id
            api(superviseApiList.findOrgByUser).then((res) => {
                if(res.data.errcode == 0) {
                    this.formData.unitName = res.data.data[0].id;
                    this.unitOrgIds = res.data.data;
                }else{
                    console.log(res.data.errmsg);
                }
            }, (error) => {})
        },
        getDepartmentData(year){//获取基本部门id
            api(superviseApiList.findDpmByUser).then((res) => {
                if(res.data.errcode == 0) {
                    // this.formData.unitName = res.data.data[0].name;
                    // this.unitList = res.data.data;
                    for(var i = 0;i<res.data.data.length;i++){
                        this.dpmIds.push(res.data.data[i].id);
                    }
                    this.getFindSurvey(year);
                    this.getFindPublicSuperviseStatus(year);
                    this.getDepartmentTypeList(year);
                    this.getFindPublicHandle(year);
                    this.getDepartmentLevelList(year);
                }else{
                    console.log(res.data.errmsg);
                }
            }, (error) => {})
        },
        getFindSurvey(y){//获取所有部门关联未处理预警的数量
            let data = {},currData=[];
            data['dpmIds'] = this.dpmIds;
            if(y)data.date=y;
            api(superviseApiList.findSurvey,data).then((res) => {
                if(res.data.errcode == 0) {
                    for(var i = 0;i<res.data.data.length;i++){
                        //整理参数
                        res.data.data[i].color = "#F7645D";
                        res.data.data[i].idName = res.data.data[i].id;
                        res.data.data[i].count = res.data.data[i].num;
                        res.data.data[i].countSize = "#50";
                        res.data.data[i].introText = res.data.data[i].name;
                        res.data.data[i].link =  `/departmentWarnAnalyzeView/${res.data.data[i].id}`;
                        currData.push(res.data.data[i]);
                        if((i != 0 && (i + 1) % 8 == 0) || i == res.data.data.length - 1) {
                            this.unitList.push(currData);
                            currData = [];
                        }
                        if(this.unitList.length>1){
                            this.arrowType='always';
                        };
                    }
                }else{
                    console.log(res.data.errmsg);
                }
            }, (error) => {})
        },
        getFindPublicSuperviseStatus(y){//各部门预警状态
            let data = {};
            data['dpmIds'] = this.dpmIds;
            if(y)data.date=y;
            api(superviseApiList.findPublicSuperviseStatus,data).then((res) => {
                if(res.data.errcode == 0) {
                    this.$refs.unitWarnState.refresh(res.data.data);
                }else{
                    console.log(res.data.errmsg);
                }
            }, (error) => {})
        },
        getDepartmentTypeList(y){//各部门预警类别情况
            let data = {};
            data['ids'] = this.dpmIds;
            if(y)data.date=y;
            api(superviseApiList.departmentTypeList,data).then((res) => {
                if(res.data.errcode == 0) {
                    this.$refs.unitCategorye.refresh(res.data.data);
                }else{
                    console.log(res.data.errmsg);
                }
            }, (error) => {})
        },
        getFindPublicHandle(y){//各部门预警处理时长对比分析
            let data = {};
            data['dpmIds'] = this.dpmIds;
            if(y)data.date=y;
            api(superviseApiList.findPublicHandle,data).then((res) => {
                if(res.data.errcode == 0) {
                    this.$refs.unitManageData.refresh(res.data.data);
                }else{
                    console.log(res.data.errmsg);
                }
            }, (error) => {})
        },
        getDepartmentLevelList(y){//各部门预警级别情况
            let data = {};
            data['ids'] = this.dpmIds;
            if(y)data.date=y;
            api(superviseApiList.departmentLevelList,data).then((res) => {
                if(res.data.errcode == 0) {
                    this.$refs.unitLevel.refresh(res.data.data);
                }else{
                    console.log(res.data.errmsg);
                }
            }, (error) => {})
        },
        pageByOrgAndSys(year){//通过单位id+体系编码获得所有部门
            let openApiReq = {
                data:{
                    orgId:this.orgId,
                    systemCode:'gxqpt',
                },
                pageNo:'1',
                pageSize:'20'
            };
            api(superviseApiList.pageByOrgAndSys,openApiReq).then((res) => {
                if(res.data.errcode == 0) {
                    this.dpmIds = [];
                    for(var i in res.data.data.list){
                        this.dpmIds.push(res.data.data.list[i].id);
                    }
                    this.getFindSurvey(year);
                    this.getFindPublicSuperviseStatus(year);
                    this.getDepartmentTypeList(year);
                    this.getFindPublicHandle(year);
                    this.getDepartmentLevelList(year);
                    console.log(this.dpmIds);
                }else{
                    console.log(res.data.errmsg);
                }
            }, (error) => {})
        },
        getUnit(val){//获取选项卡部门
            this.formData.unitName = val;
            console.log(this.unitOrgIds);
            console.log(val);
            // this.orgId = 
        },
        changeYear(val){//选取年份
            this.formData.year = val;
            // this.init(val);//初始化界面
        },
        refreshAnalyze(){//查看刷新的分析
            this.unitList = [];
            this.orgId = this.formData.unitName;
            let year = this.formData.year.toString();
            this.pageByOrgAndSys(year);
        }
    },
}
</script>

<style lang="less" scoped>
.radioMod{
    width:80%;
    height:100%;
    padding:10px 0;
    border:1px solid #ccc;
    border-radius: 50%;
    margin: 30px auto;
}
.mf{
    margin-left:2%;
}
.radioTxt{
    width:100px;
    height:100px;
    margin:35px auto;
    font-size:20px;
    text-align: center
}
.card-title{
    text-align: center;
    background-color: #888;
}
</style>
