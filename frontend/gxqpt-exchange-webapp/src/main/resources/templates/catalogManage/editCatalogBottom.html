<!doctype html>
<html>
<head>
	<meta http-equiv="Expires" content="0"/>
	<meta name="renderer" content="webkit"/>
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<link rel="stylesheet" type="text/css" href="${_static}/js/lib/bootstrap/css/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="${_static}/js/lib/ValidateForm/Validform.css">
	<link rel="stylesheet" type="text/css" href="${_static}/css/com.css">
	<link rel="stylesheet" type="text/css" href="${_static}/css/index.css">
</head>
<body class="bgNone">
<div class="workspace-body">
	<div id="console-container" class="clearfix">
		<div class="col-sm-12">
			<div class="general_list_main clearfix">
				<div class="main_bottom col-lg-12 col-sm-12">
					<div class="view_item">
						<form id="dataForm" autocomplete="off">
							<input type="hidden" name="id" id="id" value="${id}"/>
							<input type="hidden" name="unitId" id="unitId" value=""/>
							<input type="hidden" name="applyCode" id="applyCode" value=""/>
							<!--<input type="hidden" name="dirCode" id="dirCode" class="form-control"/>-->
							<table class="table default-table tab-border-no-layer" style="width: 90%;">
								<tbody>
								<tr>
									<th width="240"><span class="requiredSpan">*</span>目录名称：</th>
									<td>
										<input type="text" name="dirName" id="dirName" class="form-control" datatype="*" nullmsg="请填写目录名称！"/>
									</td>
								</tr>
								<tr class="hidden">
									<th>目录标识：</th>
									<td>
										<input type="text" name="dirType" id="dirType" class="form-control" value="2" readonly/>
									</td>
								</tr>
								<tr>
									<th>目录描述：</th>
									<td>
										<textarea id="desc" name="desc" rows="5" cols="" class="form-control"></textarea>
									</td>
								</tr>
								<tr>
									<th>是否为底层目录：</th>
									<td class="viewTd">
										<input type="hidden" name="isBottom" id="isBottom" class="form-control" readonly="readonly" value="2"/>是
									</td>
								</tr>
								<tr class="isBottom">
									<th>数据类型：</th>
									<td>
										<select id="dataType" name="dataType" class="form-control chosen-select selWid-form-search" disabled >
											<option value="1">结构化数据</option>
											<option value="2">非结构化数据</option>
										</select>
									</td>
								</tr>
								<!-- <tr id="dicCodeTr" class="isBottom">
									<th>目录编码：</th>
									<td>
										<input type="text" name="dirCode" id="dirCode" class="form-control"  readonly="readonly" ignoreHidden="true"  />
									</td>
								</tr> -->
								<tr class="isBottom">
									<th width="210"><span class="requiredSpan">*</span>主题分类：</th>
									<td>
										<input type="hidden" name="themeOne" id="themeOne" class="form-control"/>
										<input type="hidden" name="themeTwo" id="themeTwo" class="form-control"/>
										<input type="hidden" name="themeThree" id="themeThree" class="form-control"/>
										<input type="text" name="theme" id="theme" class="form-control" onclick="openZtree('theme')" datatype="*" nullmsg="请选择主题分类！"/>
									</td>
								</tr>
								<tr class="isBottom">
									<th><span class="requiredSpan">*</span>行业分类：</th>
									<td>
										<input type="hidden" name="industryOne" id="industryOne" class="form-control"/>
										<input type="hidden" name="industryTwo" id="industryTwo" class="form-control"/>
										<input type="hidden" name="industryThree" id="industryThree" class="form-control"/>
										<input type="text" name="industry" id="industry" class="form-control" onclick="openZtree('industry')" datatype="*" nullmsg="请选择行业分类！"/>
									</td>
								</tr>
								<tr class="isBottom">
									<th><span class="requiredSpan">*</span>服务分类：</th>
									<td>
										<input type="hidden" name="serviceOne" id="serviceOne" class="form-control"/>
										<input type="hidden" name="serviceTwo" id="serviceTwo" class="form-control"/>
										<input type="hidden" name="serviceThree" id="serviceThree" class="form-control"/>
										<input type="text" name="service" id="service" class="form-control" onclick="openZtree('service')" datatype="*" nullmsg="请选择服务分类！"/>
									</td>
								</tr>
								<tr class="isBottom">
									<th>领域分类：</th>
									<td>
										<select id="domain" name="domain" class="form-control chosen-select">
										</select>
									</td>
								</tr>
								<tr class="isBottom">
									<th>专题分类：</th>
									<td>
										<select id="specialType" name="specialType" class="form-control chosen-select">
										</select>
									</td>
								</tr>
								<tr class="isBottom">
									<th>开放方式：</th>
									<td>
										<select id="openType" name="openWay" class="form-control chosen-select" onchange="setOpenType()">
											<option value="1">开放</option>
											<option value="2">不开放</option>
										</select>
									</td>
								</tr>
								<tr class="shareType" style="display: none;">
									<th>共享方式：</th>
									<td>
										<select id="shareType" name="shareWay" class="form-control chosen-select selWid-form-search" onchange="reasonTogger()">
											<option value="1">无条件共享</option>
											<option value="2">有条件共享</option>
											<option value="3">不共享</option>
										</select>
									</td>
								</tr>
								<tr class="reason" style="display: none;">
									<th><span class="requiredSpan">*</span>不共享、不开放、有条件共享原因：</th>
									<td>
										<textarea id="reason" name="reason" rows="5" cols="" class="form-control" datatype="*" nullmsg="请填写不共享、不开放、有条件共享原因！"></textarea>
									</td>
								</tr>
								<tr class="reason defalutUnit" style="display: none;">
									<th class="vtop">默认共享单位：</th>
									<td>
										<ul id="unitList" class="elementData  clearfix">
										</ul>
									</td>
								</tr>
								</tbody>
							</table>
							<button type="button" class="btn-submit hidden"></button>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript" src="${_static}/js/lib/jquery/jquery.min.js" charset="utf-8"></script>
<script type="text/javascript" src="${_static}/js/lib/jquery/jquery.cookie.js"  charset="utf-8"></script>
<script type="text/javascript" src="${_static}/js/hengyun/hengyun_ajax.js"></script>
<script type="text/javascript" src="${_static}/js/lib/serializeJSON/jquery.serializejson.min.js"></script>
<script type="text/javascript" src="${_static}/js/lib/layer/layer.js"></script>
<script type="text/javascript" src="${_static}/js/lib/ValidateForm/Validform_v5.3.2_min.js"></script>
<script type="text/javascript" src="${_static}/js/lib/ValidateForm/Valid.js"></script>
<script type="text/javascript" src="${_static}/js/com.js" charset="utf-8"></script>
<script type="text/javascript">
    getUnitList();
    function getCatalogInfo(id){
        ajaxHengyun({
            type:"GET",

            dataType: 'json',
            url:  '${_gate_url}/api/exchange/directory/get',
            data:{id:id},
            success:function(rows){
                if(rows.data){
                    var rowsObject=dealElement(rows.data);
                    $("#dirName").val(rowsObject.dirName);
                    $("#unitId").val(rowsObject.unitId);
                    $("#unitIds").val(rowsObject.unitIds);
                    $("#id").val(rowsObject.id);
                    $("#applyCode").val(rowsObject.applyCode);
                    $("#dirCode").val(rowsObject.dirCode);
                    $("#desc").val(rowsObject.desc);
                    $("#themeOne").val(rowsObject.themeOne);
                    $("#themeTwo").val(rowsObject.themeTwo);
                    $("#themeThree").val(rowsObject.themeThree);
                    var themeName="";
                    if(rowsObject.themeOneName!=""){
                        themeName+=rowsObject.themeOneName;
                        if(rowsObject.themeTwoName!=""){
                            themeName+=">"+rowsObject.themeTwoName;
                            if(rowsObject.themeThreeName!=""){
                                themeName+=">"+rowsObject.themeThreeName;
                            }
						}
					}
                    $("#theme").val(themeName);
                    $("#industryOne").val(rowsObject.industryOne);
                    $("#industryTwo").val(rowsObject.industryTwo);
                    $("#industryThree").val(rowsObject.industryThree);
                    var industryName="";
                    if(rowsObject.industryOneName!=""){
                        industryName+=rowsObject.industryOneName;
                        if(rowsObject.industryTwoName!=""){
                            industryName+=">"+rowsObject.industryTwoName;
                            if(rowsObject.industryThreeName!=""){
                                industryName+=">"+rowsObject.industryThreeName;
                            }
                        }
                    }
                    $("#industry").val(industryName);
                    $("#serviceOne").val(rowsObject.serviceOne);
                    $("#serviceTwo").val(rowsObject.serviceTwo);
                    $("#serviceThree").val(rowsObject.serviceThree);
                    var serviceName="";
                    if(rowsObject.serviceOneName!=""){
                        serviceName+=rowsObject.serviceOneName;
                        if(rowsObject.serviceTwoName!=""){
                            serviceName+=">"+rowsObject.serviceTwoName;
                            if(rowsObject.serviceThreeName!=""){
                                serviceName+=">"+rowsObject.serviceThreeName;
                            }
                        }
                    }
                    $("#service").val(serviceName);
                    $("#domain").val(rowsObject.domain);
                    $("#specialType").val(rowsObject.specialType);
                    $("#openType").val(rowsObject.openWay);
                    $("#shareType").val(rowsObject.shareWay);
                    $("#dataType").val(rowsObject.dataType);
                    $("#reason").val(rowsObject.reason);
                    setOpenType();
                    reasonTogger();
                    if(rowsObject.unitIds.length>0){
                        rowsObject.unitIds.forEach(function(value,index){
                            var eleInput="input[name='unitIdsBox'][value='"+value+"']";
							$(eleInput).parent().find(".selectno").addClass("checked");
                            $(eleInput).prop("checked",true);
						})
					}
                    getWare("${id}");
                }
            }
        });
    }
    function getWare(id){//查询数据目录是否发布
        ajaxHengyun({
            type: "GET",
            dataType: 'json',
            url: '${_gate_url}/api/exchange/directory/getWare',
            data: {id: id},
            success: function (rows) {
                if(rows.data){
                    $("#openType,#shareType").prop("disabled",true);
				}
            }
        });
	}
    function setOpenType() {
        var type = $("#openType").val();
        if(type=="2"){
            $(".shareType").css("display","table-row");
        }else if(type=="1"){
            $(".shareType,.reason").css("display","none");
        }
    }
    function reasonTogger() {
        var type = $("#shareType").val();
        if(type=="2" || type=="3"){
            $(".reason").css("display","table-row");
            if(type=="3"){
                $(".defalutUnit").css("display","none");
            }
        }else if(type=="1"){
            $(".reason").css("display","none");
        }
    }
    $("body").on("click",".selectno",function(){
        if($(this).hasClass("checked")){
            $(this).removeClass("checked");
            var ipt = $(this).parent().find("input");
            $(ipt).removeAttr("checked");
        }else{
            $(this).addClass("checked");
            var ipt = $(this).parent().find("input");
            $(ipt).prop("checked",true);
        }
    });
    function openZtree(type){
        layer.open({
            id: 'setUnitDep',
            type: 2,
            anim:6,
            title: '分类选择',
            maxmin: false, //开启最大化最小化按钮
            area: ['50%', '80%'],
            content: "${_cp}/module/openZtree?type="+type,
            btn: ['<span class="glyphicon glyphicon-ok"></span> 确认','<span class="glyphicon glyphicon-remove"></span> 取消'],
            yes: function (index, layero) {
                var iframeWin = window[layero.find('iframe')[0]['name']];
                iframeWin.save(index);
            }
        });
    }
    getZtree();
    function getZtree(){//获取领域列表
        ajaxHengyun({
            type: 'GET',
            url: '${_gate_url}/api/exchange/dataapi/api/findByDictCode',
            data:{pId: "domain"},
            datatype: "json",
            success: function (rows) {
                if(rows.data){
                    var html="";
                    rows.data.forEach(function(value,index) {
                        html+= '<option value="'+value.dictCode+'">'+value.dictName+'</option>';
                    });
                    $("#domain").html(html);
                }
            }
        });
    }
    getSpecialType();
    function getSpecialType(){//获取专题列表
        ajaxHengyun({
            type: 'GET',
            url: '${_gate_url}/api/exchange/dataapi/api/findByDictCode',
            data:{pId: "special_type"},
            datatype: "json",
            success: function (rows) {
                if(rows.data){
                    var html="";
                    rows.data.forEach(function(value,index) {
                        html+= '<option value="'+value.dictCode+'">'+value.dictName+'</option>';
                    });
                    $("#specialType").html(html);
                }
            }
        });
    }
    function getUnitList(){//获取单位列表
        ajaxHengyun({
            type: 'GET',
            url: '${_gate_url}/api/exchange/directory/getOrgList ',
            datatype: "json",
            success: function (rows) {
                if(rows.data){
                    var html="";
                    for(var i in rows.data){
                        html+='<li class="pull-left clearfix">';
                        html+='<input type="checkbox" name="unitIdsBox" class="hidden" value="'+rows.data[i].id+'"/>';
                        html+='<span class="selectno"></span>';
                        html+='<label class="pull-left">'+rows.data[i].name_+'</label>';
                        html+='</li>';
                    }
                    $("#unitList").append(html);
                }
				getCatalogInfo("${id}");
            }
        });
    }
    function setType(index,type,typeId,typeName){
        typeId=typeId.reverse();
        typeName=typeName.reverse();
        if(type){
            if(typeId.length>=1){
                $("#"+type+"One").val(typeId[0]);
            }
            if(typeId.length>=2){
                $("#"+type+"Two").val(typeId[1]);
            }
            if(typeId.length>=3){
                $("#"+type+"Three").val(typeId[2]);
            }
            // $("#"+type).val(typeName);
            $("#"+type).val(typeName.join(">")).blur();
        };
        layer.closeAll();
    };
    var index="";
    function save(num){
        index=num;
        $('.btn-submit').click();
    }
    $('.btn-submit').valid({
        form: '#dataForm',
        //showAllError:可选项 true | false，true：提交表单时所有错误提示信息都会显示，
        //false：一碰到验证不通过的就停止检测后面的元素，只显示该元素的错误信息;
        showAllError: true,
        ignoreHidden: true,
        checkpassed: function () {
            saveObj();
        }
    });
    /*提交*/
    function saveObj(){
        var unitIds=[];
        var inputCheckbox=$("input[name=unitIdsBox]:checked");
        inputCheckbox.each(function(index,value){
            unitIds.push($(value).val());
        });
        var gxqptDutiesDTO =$("#dataForm").serializeJSON();
        gxqptDutiesDTO.unitIds=unitIds;
        gxqptDutiesDTO.dataType = $("#dataType").val();
        ajaxHengyun({
            type:"POST",

            dataType: 'json',
            contentType: 'application/json',
            url:  '${_gate_url}/api/exchange/directory/update',
            data:JSON.stringify(gxqptDutiesDTO),
            success:function(rows){
                if (rows.data){
                    gxqptDutiesDTO.type="catalog_bottom";
                    gxqptDutiesDTO.isParent=true;
                    parent.home.updateNode(gxqptDutiesDTO);
                    parent.home.reloadPage("${id}","catalog_bottom");
                    parent.layer.msg("编辑元目录成功！",{time:1000});
                    parent.layer.close(index);
                }else{
                    parent.layer.msg(rows.errmsg+"，请重试！",{time:3000});
                }
            }
        });
    };
 /*   function setDataType(){
        var setDataTypeVal = $("#dataType").val();
        if(setDataTypeVal=="2"){
            $("#dicCodeTr").css("display","none");
            $("#dicCodeTr .Validform_info").remove();
            $("#dicCodeTr").val("");
        }else{
            $("#dicCodeTr").css("display","table-row");
        }
    }*/
</script>
</body>
</html>