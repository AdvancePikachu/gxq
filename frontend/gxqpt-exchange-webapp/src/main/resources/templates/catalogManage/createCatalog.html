<!doctype html>
<html>
	<head>
		<meta http-equiv="Expires" content="0"/>
	    <meta name="renderer" content="webkit"/>
	    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
	    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<link rel="stylesheet" type="text/css" href="${_static}/js/lib/bootstrap/css/bootstrap.css">
		<link rel="stylesheet" type="text/css" href="${_static}/js/lib/ValidateForm/Validform.css">
		<link rel="stylesheet" type="text/css" href="${_static}/css/com.css">
		<link rel="stylesheet" type="text/css" href="${_static}/css/index.css">
		<style>
			.isBottom{display: none}
			.tab-border-no-layer tbody tr td{position: relative;}
		</style>
	</head>
	<body class="bgNone">
		<div class="workspace-body">
			<div id="console-container" class="clearfix">
				<div class="col-sm-12">
					<div class="general_list_main clearfix">
						<div class="main_bottom col-lg-12 col-sm-12">
							<div class="view_item" ng-app="app" ng-controller="controller">
								<form id="dataForm" autocomplete="off">
									<input type="hidden" name="unitId" id="unitId" value="${unitId}"/>
									<input type="hidden" name="parentId" id="parentId" value="${id}"/>
									<!--<input type="hidden" name="dirCode" id="dirCode" class="form-control"/>-->
									<table class="table default-table tab-border-no-layer">
										<tbody>
										<tr>
											<th width="120"><span class="requiredSpan">*</span>目录名称：</th>
											<td>
												<input type="text" name="dirName" id="dirName" class="form-control" datatype="*" nullmsg="请填写目录名称！"/>
											</td>
										</tr>
										<tr class="hidden">
											<th>目录标识：</th>
											<td>
												<input type="text" name="dirType" id="dirType" class="form-control" value="2" readonly/>
											</td>
										</tr>
										<tr>
											<th>目录描述：</th>
											<td>
												<textarea id="desc" name="desc" rows="5" cols="" class="form-control"></textarea>
											</td>
										</tr>
										<tr>
											<th>是否为底层目录：</th>
											<td>
												<select id="isBottom" name="isBottom" class="form-control chosen-select" onchange="setIsBottom()">
													<option value="1">否</option>
													<option value="2">是</option>
												</select>
											</td>
										</tr>
										<tr class="isBottom">
											<th>数据类型：</th>
											<td>
												<select id="type" name="dataType" class="form-control chosen-select selWid-form-search" >
													<option value="1">结构化数据</option>
													<option value="2">非结构化数据</option>
												</select>
											</td>
										</tr>
										<!-- <tr id="dicCodeTr" class="isBottom">
											<th>目录编码：</th>
											<td>
												<input type="text" name="dirCode" id="dirCode" class="form-control" ignoreHidden="true"  ignore="ignore"/>
											</td>
										</tr> -->
										<tr class="isBottom">
											<th width="210"><span class="requiredSpan">*</span>主题分类：</th>
											<td>
												<input type="hidden" name="themeOne" id="themeOne" class="form-control"/>
												<input type="hidden" name="themeTwo" id="themeTwo" class="form-control"/>
												<input type="hidden" name="themeThree" id="themeThree" class="form-control"/>
												<input type="text" name="theme" id="theme" class="form-control" onclick="openZtree('theme')" datatype="*" nullmsg="请选择主题分类！"/>
											</td>
										</tr>
										<tr class="isBottom">
											<th><span class="requiredSpan">*</span>行业分类：</th>
											<td>
												<input type="hidden" name="industryOne" id="industryOne" class="form-control"/>
												<input type="hidden" name="industryTwo" id="industryTwo" class="form-control"/>
												<input type="hidden" name="industryThree" id="industryThree" class="form-control"/>
												<input type="text" name="theme" id="industry" class="form-control" onclick="openZtree('industry')" datatype="*" nullmsg="请选择行业分类！"/>
											</td>
										</tr>
										<tr class="isBottom">
											<th><span class="requiredSpan">*</span>服务分类：</th>
											<td>
												<input type="hidden" name="serviceOne" id="serviceOne" class="form-control"/>
												<input type="hidden" name="serviceTwo" id="serviceTwo" class="form-control"/>
												<input type="hidden" name="serviceThree" id="serviceThree" class="form-control"/>
												<input type="text" name="theme" id="service" class="form-control" onclick="openZtree('service')" datatype="*" nullmsg="请选择服务分类！"/>
											</td>
										</tr>
										<tr class="isBottom">
											<th>领域分类：</th>
											<td>
												<select id="domain" name="domain" class="form-control chosen-select">
												</select>
											</td>
										</tr>
										<tr class="isBottom">
											<th>专题分类：</th>
											<td>
												<select id="specialType" name="specialType" class="form-control chosen-select">
												</select>
											</td>
										</tr>
										<tr class="isBottom">
											<th>开放方式：</th>
											<td>
												<select id="openType" name="openWay" class="form-control chosen-select" onchange="setOpenType()">
													<option value="1">开放</option>
													<option value="2">不开放</option>
												</select>
											</td>
										</tr>
										<tr class="shareType" style="display: none;">
											<th>共享方式：</th>
											<td>
												<select id="shareType" name="shareWay" class="form-control chosen-select selWid-form-search" onchange="reasonTogger()">
													<option value="1">无条件共享</option>
													<option value="2">有条件共享</option>
													<option value="3">不共享</option>
												</select>
											</td>
										</tr>
										<tr class="reason" style="display: none;">
											<th><span class="requiredSpan">*</span>不共享、不开放、有条件共享原因：</th>
											<td>
												<textarea id="reason" name="reason" rows="5" cols="" class="form-control" datatype="*" nullmsg="请填写不共享、不开放、有条件共享原因！"></textarea>
											</td>
										</tr>
										<tr class="reason defalutUnit" style="display: none;">
											<th class="vtop">默认共享单位：</th>
											<td>
												<ul id="unitList" class="elementData  clearfix">
												</ul>
											</td>
										</tr>
										</tbody>
									</table>
									<button type="button" class="btn-submit hidden"></button>
								</form>
							</div>
						</div>
					</div>
				</div>	
			</div>
		</div>
		<script type="text/javascript" src="${_static}/js/lib/jquery/jquery.min.js" charset="utf-8"></script>
		<script type="text/javascript" src="${_static}/js/lib/jquery/jquery.cookie.js"  charset="utf-8"></script>
		<script type="text/javascript" src="${_static}/js/hengyun/hengyun_ajax.js"></script>
		<script type="text/javascript" src="${_static}/js/lib/serializeJSON/jquery.serializejson.min.js"></script>
		<script type="text/javascript" src="${_static}/js/lib/layer/layer.js"></script>
		<script type="text/javascript" src="${_static}/js/lib/ValidateForm/Validform_v5.3.2_min.js"></script>
		<script type="text/javascript" src="${_static}/js/lib/ValidateForm/Valid.js"></script>
		<script type="text/javascript" src="${_static}/js/lib/hengyun/hengyun_validator.js"></script>
		<script type="text/javascript" src="${_static}/js/lib/angular/angular.min-1-4-6.js"></script>
		<script type="text/javascript">
            $(function(){
                openValidator({
                    type:"POST",
                    dataType: 'json',
                    contentType : 'application/json',
                    url: '${_gate_url}/api/exchange/directory/save',
                },"#dataForm",{
                    attrName:"name",
                    prefix:"",
                    suffix:"",
                });
            })
			function setIsBottom() {
				var type = $("#isBottom").val();
				if(type=="2"){
					$(".isBottom").css("display","table-row");
				}else if(type=="1"){
					$(".isBottom").css("display","none");
				}
			}
			function setOpenType() {
				var type = $("#openType").val();
				if(type=="2"){
					$(".shareType").css("display","table-row");
				}else if(type=="1"){
					$(".shareType,.reason").css("display","none");
				}
			}
			function reasonTogger() {
				var type = $("#shareType").val();
				if(type=="2" || type=="3"){
					$(".reason").css("display","table-row");
					if(type=="3"){
						$(".defalutUnit").css("display","none");
					}
				}else if(type=="1"){
					$(".reason").css("display","none");
				}
			}
            $("body").on("click",".selectno",function(){
                if($(this).hasClass("checked")){
                    $(this).removeClass("checked");
                    var ipt = $(this).parent().find("input");
                    $(ipt).removeAttr("checked");
                }else{
                    $(this).addClass("checked");
                    var ipt = $(this).parent().find("input");
                    $(ipt).prop("checked",true);
                }
            });
			function openZtree(type){
                layer.open({
                    id: 'setUnitDep',
                    type: 2,
                    anim:6,
                    title: '分类选择',
                    maxmin: false, //开启最大化最小化按钮
                    area: ['50%', '80%'],
                    content: "${_cp}/module/openZtree?type="+type,
                    btn: ['<span class="glyphicon glyphicon-ok"></span> 确认','<span class="glyphicon glyphicon-remove"></span> 取消'],
                    yes: function (index, layero) {
                        var iframeWin = window[layero.find('iframe')[0]['name']];
                        iframeWin.save(index);
                    }
                });
			}
            getZtree();
            function getZtree(){//获取领域列表
                ajaxHengyun({
                    type: 'GET',
                    url: '${_gate_url}/api/exchange/dataapi/api/findByDictCode',
                    data:{pId: "domain"},
                    datatype: "json",
                    success: function (rows) {
                        if(rows.data){
                        	var html="";
							rows.data.forEach(function(value,index) {
                                html+= '<option value="'+value.dictCode+'">'+value.dictName+'</option>';
                            });
							$("#domain").html(html);
                        }
                    }
                });
            }
            getSpecialType();
            function getSpecialType(){//获取专题列表
                ajaxHengyun({
                    type: 'GET',
                    url: '${_gate_url}/api/exchange/dataapi/api/findByDictCode',
                    data:{pId: "special_type"},
                    datatype: "json",
                    success: function (rows) {
                        if(rows.data){
                            var html="";
                            rows.data.forEach(function(value,index) {
                                html+= '<option value="'+value.dictCode+'">'+value.dictName+'</option>';
                            });
                            $("#specialType").html(html);
                        }
                    }
                });
            }
            function getDirCode(ele){//查询目录编码是否存在
				var dirCode=$(ele).val();
				if(dirCode==""){
				    return false;
				};
                ajaxHengyun({
                    type: 'GET',
                    url: '${_gate_url}/api/exchange/directory/getDirCode',
                    data:{dirCode: dirCode},
                    datatype: "json",
                    success: function (rows) {
                        if(!rows.data){
                            $("#dirCode").val("");
                            parent.layer.msg("数据库表名称已存在，请重新填写！",{time:1500});
                        }
                    }
                });
            }
            getUnitList();
			function getUnitList(){//获取单位列表
                ajaxHengyun({
                    type: 'GET',
                    url: '${_gate_url}/api/exchange/directory/getOrgList ',
                    datatype: "json",
                    success: function (rows) {
                        if(rows.data){
                        var html="";
                        for(var i in rows.data){
                            html+='<li class="pull-left clearfix">';
                            html+='<input type="checkbox" name="unitIdsBox" class="hidden" value="'+rows.data[i].id+'"/>';
                            html+='<span class="selectno"></span>';
                            html+='<label class="pull-left">'+rows.data[i].name_+'</label>';
                            html+='</li>';
						}
                        $("#unitList").append(html);
                        }
                    }
                });
			}
            function setType(index,type,typeIds,typeName){
                typeIds=typeIds.reverse();
                typeName=typeName.reverse();
            	if(type){
                    if(typeIds.length>=3){
                        $("#"+type+"Three").val(typeIds[2]);
                    }
                    if(typeIds.length>=2){
                        $("#"+type+"Two").val(typeIds[1]);
                    }
            	    if(typeIds.length>=1){
            	    	$("#"+type+"One").val(typeIds[0]);
					}
					typeName.join(">");
                    $("#"+type).val(typeName.join(">")).blur();
				};
            	layer.closeAll();
			};
            var index="";
            function save(num){
                index=num;
                $('.btn-submit').click();
            }
           /* $('.btn-submit').valid({
                form: '#dataForm',
                //showAllError:可选项 true | false，true：提交表单时所有错误提示信息都会显示，
                //false：一碰到验证不通过的就停止检测后面的元素，只显示该元素的错误信息;
                showAllError: true,
                ignoreHidden: true,
                checkpassed: function () {
                    saveObj();
                }
            });*/
            /*----------------------angular.js---------------------------------------*/
            var app = angular.module('app', []);

            app.controller('controller', function ($scope,$http,token) {
                var urlPrev ='${_gate_url}';
                $scope.save = function () {
                    saveObj();
                }
            }).service('token',function () {
                this.getToken = function () {
                    return getToken();
                }
            });
            $('.btn-submit').valid({
                form: '#dataForm',
                showAllError: true,
                ignoreHidden: true,
                checkpassed: function () {
                    var appElement = document.querySelector('[ng-controller=controller]');
                    var $scope = angular.element(appElement).scope();
                    $scope.save();
                }
            });

            /*提交*/
            function saveObj(){
                var unitIds=[];
                var inputCheckbox=$("input[name=unitIdsBox]:checked");
                inputCheckbox.each(function(index,value){
                    unitIds.push($(value).val());
				});
                var gxqptDutiesDTO =$("#dataForm").serializeJSON();
                gxqptDutiesDTO.unitIds=unitIds;
                if(gxqptDutiesDTO.isBottom==1){
                    gxqptDutiesDTO.dataType=null;
				};
                ajaxHengyun({
                    type:"POST",

                    dataType: 'json',
                    contentType: 'application/json',
                    url:  '${_gate_url}/api/exchange/directory/save',
                    data:JSON.stringify(gxqptDutiesDTO),
                    success:function(rows){
                        if (rows.data){
                            if(rows.data.isBottom ==1){
                                rows.data.type="catalog";
                                parent.home.reloadPage(rows.data.id,"catalog");
							}
                            if(rows.data.isBottom ==2){
                                rows.data.type="catalog_bottom";
                                parent.home.reloadPage(rows.data.id,"catalog_bottom");
                            }
                            rows.data.isParent=true;
                            parent.home.addNodes(rows.data,"${id}");
                            parent.layer.msg("新增成功！",{time:1000});
                            parent.layer.close(index);
                        }else{
                            parent.layer.msg(rows.errmsg+"，请重试！",{time:3000});
                        }
                    }
                });
            };
            $("#dirCode").blur(function(){
                if(!$("#dirCode").val()){
                    $(this).parent().find(".Validform_info").remove();
				}
			})
            /* function setDataType(){
                 var setDataTypeVal = $("#type").val();
                 if(setDataTypeVal=="2"){
                     $("#dicCodeTr").css("display","none");
                     $("#dicCodeTr .Validform_info").remove();
                     $("#dicCodeTr").val("");
                 }else{
                     $("#dicCodeTr").css("display","table-row");
                 }
			}*/
		</script>
	</body>
</html>